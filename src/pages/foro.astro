---

import Layout from "../layouts/Layout.astro"
import Header from "../components/Header.astro"
import Foro from "../components/Foro.astro"

// ðŸ”¥ Leemos la cookie "session"
const sessionCookie = Astro.cookies.get("session");

let user = undefined;

if (sessionCookie?.value) {
  try {
    user = JSON.parse(sessionCookie.value);
  } catch (e) {
    console.error("Cookie de sesiÃ³n mal formada:", e);
  }
}

// Si NO hay usuario â†’ redirigir al login
if (!user) {
  return Astro.redirect("/api/auth/login");
}

// Obtener posts desde la API
const res = await fetch("http://localhost:4321/api/posts");
const posts = await res.json();

---

<Layout>
  <Header user={user} />
  <Foro user={user} posts={posts} />
</Layout>