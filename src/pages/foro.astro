---
import Layout from "../layouts/Layout.astro"
import Header from "../components/Header.astro"
import Foro from "../components/Foro.astro"
import { prisma } from "../lib/prisma"; 

const sessionCookie = Astro.cookies.get("session");

let user = undefined;

if (sessionCookie?.value) {
  try {
    const sessionData = JSON.parse(sessionCookie.value);
    
    if (sessionData.discordId) {
        user = await prisma.user.findUnique({
            where: { discordId: sessionData.discordId }
        });
    } else if (sessionData.username) {
         user = await prisma.user.findFirst({
            where: { username: sessionData.username }
        });
    }

  } catch (e) {
    console.error("Error recuperando usuario de la BD:", e);
  }
}

if (!user) {
  return Astro.redirect("/api/auth/login");
}

const res = await fetch("http://localhost:4321/api/posts");
const posts = await res.json();
---

<Layout>
  <Header user={user} />
  <Foro user={user} posts={posts} />
</Layout>