---
import { getNewsPosts } from '../pages/api/news.ts'; 

const allPosts = await getNewsPosts();

function getChileDate() {
  const now = new Date();
  const chileTimeStr = now.toLocaleString("en-US", { timeZone: "America/Santiago" });
  const chileDate = new Date(chileTimeStr);
  chileDate.setHours(0, 0, 0, 0);
  return chileDate;
}

const todayInChile = getChileDate();

const posts = allPosts.filter((post) => {
  const startDate = new Date(post.postDate);
  startDate.setHours(0, 0, 0, 0);

  const endDate = new Date(post.downDate);
  endDate.setHours(0, 0, 0, 0);

  return todayInChile.getTime() >= startDate.getTime() && todayInChile.getTime() <= endDate.getTime();
});
---

<div class="w-full max-w-6xl mx-auto p-6">
  
  {posts.length === 0 && (
    <div class="text-center text-gray-400 py-10">
      <p>No hay publicaciones vigentes en este momento.</p>
    </div>
  )}

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    {posts.map((post) => {
      const postData = encodeURIComponent(JSON.stringify(post));
      
      return (
        <article 
          class="post-card flex flex-col sm:flex-row h-full bg-black/20 border border-[#64ffd6] shadow-lg shadow-[#00ffbb]/10 hover:shadow-[#00ffbb]/40 transition-all duration-300 rounded-lg overflow-hidden hover:-translate-y-1 group cursor-pointer relative select-none"
          data-post={postData}
        >
          <div class="w-full sm:w-1/3 h-48 sm:h-auto relative overflow-hidden shrink-0">
            <img 
              src={post.imageUrl} 
              alt={post.title}
              class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 pointer-events-none" 
            />
          </div>

          <div class="p-5 flex flex-col flex-grow w-full sm:w-2/3">
            <h2 class="text-xl text-[#00ffbb] font-bold mb-3 leading-tight group-hover:underline decoration-[#00ffbb]/50 underline-offset-4 transition-all">
              {post.title}
            </h2>
            
            <p class="text-gray-300 text-sm mb-4 flex-grow line-clamp-3">
              {post.description}
            </p>

            <div class="mt-auto pt-4 border-t border-[#64ffd6]/30">
              <span class="text-white text-xs font-semibold uppercase tracking-wider flex items-center gap-2 group-hover:text-[#00ffbb] transition-colors">
                Leer publicaci√≥n
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-[#00ffbb]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </span>
            </div>
          </div>

        </article>
      );
    })}
  </div>

</div>

<div 
  id="public-post-modal" 
  class="fixed inset-0 z-[9999] hidden caret-transparent"
  aria-labelledby="modal-title" 
  role="dialog" 
  aria-modal="true"
>
  <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>

  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      
      <div class="relative transform overflow-hidden rounded-lg bg-[#1a1a1a] border border-[#64ffd6] text-left shadow-2xl shadow-[#00ffbb]/20 transition-all sm:my-8 sm:w-full sm:max-w-2xl">
        
        <button 
          id="modal-close-btn"
          class="absolute top-4 right-4 text-gray-400 hover:text-[#00ffbb] transition-colors z-10 bg-black/20 p-1 rounded-full backdrop-blur-md"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <div class="relative h-64 w-full">
           <img id="modal-img" src="" alt="Detalle" class="w-full h-full object-cover" />
           <div class="absolute inset-0 bg-gradient-to-t from-[#1a1a1a] via-[#1a1a1a]/40 to-transparent"></div>
        </div>

        <div class="px-8 py-6">
          <h3 class="text-2xl font-bold leading-6 text-[#00ffbb] mb-2" id="modal-title">
            </h3>
          
          <p class="text-xs text-gray-500 mb-6 flex items-center gap-2">
             Publicado el: <span id="modal-date" class="text-gray-300"></span>
          </p>
          
          <div class="prose prose-invert max-w-none">
            <p id="modal-description" class="text-gray-300 whitespace-pre-line leading-relaxed text-base">
              </p>
          </div>
        </div>
        
        <div class="bg-[#111] px-6 py-4 flex justify-end border-t border-[#64ffd6]/20">
          <button 
            type="button" 
            id="modal-close-btn-bottom"
            class="inline-flex w-full justify-center rounded-md bg-[#00ffbb] px-3 py-2 text-sm font-semibold text-black shadow-sm hover:bg-[#00cc99] sm:ml-3 sm:w-auto transition-colors"
          >
            Cerrar
          </button>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('public-post-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalDesc = document.getElementById('modal-description');
  const modalImg = document.getElementById('modal-img');
  const modalDate = document.getElementById('modal-date');
  const backdrop = document.getElementById('modal-backdrop');
  const closeBtn = document.getElementById('modal-close-btn');
  const closeBtnBottom = document.getElementById('modal-close-btn-bottom');
  const cards = document.querySelectorAll('.post-card');

  function openModal(post) {
    if (!modal) return;

    modalTitle.textContent = post.title;
    modalDesc.textContent = post.description;
    modalImg.src = post.imageUrl;

    const dateObj = new Date(post.postDate);
    modalDate.textContent = dateObj.toLocaleDateString('es-CL', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      timeZone: 'UTC'
    });

    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    if (!modal) return;
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  }

  cards.forEach(card => {
    card.addEventListener('click', (e) => {
      const target = e.currentTarget; 
      if (target instanceof HTMLElement) {
        try {
          const postData = JSON.parse(decodeURIComponent(target.dataset.post || '{}'));
          openModal(postData);
        } catch (err) {
          console.error('Error al procesar datos del post:', err);
        }
      }
    });
  });

  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (closeBtnBottom) closeBtnBottom.addEventListener('click', closeModal);
  if (backdrop) backdrop.addEventListener('click', closeModal);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
      closeModal();
    }
  });
</script>