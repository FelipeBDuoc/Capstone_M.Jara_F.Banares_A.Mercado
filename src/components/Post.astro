---
// Importamos TU cliente de prisma compartido
import { prisma } from "../lib/prisma"; 

// 1. OBTENER LA COOKIE
const sessionCookie = Astro.cookies.get("session");

// Si no hay cookie, no está logueado -> Al login
if (!sessionCookie) {
  return Astro.redirect("/login"); // O la ruta donde inicies sesión
}

// 2. LEER DATOS DE LA SESIÓN
const session = sessionCookie.json();

// 3. OBTENER EL USUARIO REAL DE LA BD
// La cookie tiene el 'discordId' (session.id), pero necesitamos el ID interno (id)
// para crear la relación con el Post.
const dbUser = await prisma.user.findUnique({
  where: { 
    discordId: session.id 
  }
});

// Seguridad extra: Si tiene cookie pero no está en la BD
if (!dbUser) {
    // Podrías borrar la cookie aquí si quisieras
    return Astro.redirect("/?error=usuario_no_encontrado");
}
---

<main class="max-w-2xl mx-auto bg-gray-900 p-6 rounded-xl shadow-xl space-y-6">
  <h1 class="text-3xl font-bold text-blue-400 mb-4">Crear un nuevo post</h1>
  
  <form action="/api/posts/create" method="POST" class="space-y-4">
    <div>
      <label class="block mb-1 font-semibold text-white">Título del post</label>
      <input
        type="text"
        name="title"
        required
        class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 text-white outline-none"
      />
    </div>
    
    <div>
      <label class="block mb-1 font-semibold text-white">Contenido</label>
      <textarea
        name="content"
        rows="7"
        required
        class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700 focus:border-blue-500 text-white outline-none"
      ></textarea>
    </div>

    <input type="hidden" name="authorId" value={dbUser.id} />

    <button
      type="submit"
      class="w-full bg-blue-600 hover:bg-blue-700 transition text-white py-2 rounded-lg font-semibold"
    >
      Publicar como {session.username}
    </button>
  </form>

  <a href="/foro" class="block text-center text-gray-400 hover:text-white transition">Volver al foro</a>
</main>