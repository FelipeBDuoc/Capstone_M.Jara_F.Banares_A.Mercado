<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/progressbar.js@1.1.0/dist/progressbar.min.js"></script>


<style>
    /* --- Tus colores de tema oscuro --- */
    .bg-dark-primary { background-color: #1a1a2e; }
    .bg-dark-secondary { background-color: #1f2335; }
    .bg-dark-tertiary { background-color: #25283b; }
    .bg-dark-accent { background-color: #2d3047; }
    
    .border-dark { border-color: #33354a; }
    .border-dark-accent { border-color: #4a4e69; }
    .border-dark-highlight { border-color: #5a5f87; }
    
    .text-light { color: #00ffb9; }
    .text-muted { color: #a0aec0; } 
    
    /* --- Estilo para el texto del porcentaje --- */
    /* (Texto un poco m√°s peque√±o para que quepa bien) */
    .progressbar-text {
      color: #FFFFFF !important;
      font-weight: 600 !important;
      font-size: 1.125rem !important; /* 18px */
      position: absolute !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
    }
</style>

<div class="flex h-screen gap-px bg-dark-accent">
    <div class="sidebar w-1/5 bg-dark-secondary flex flex-col overflow-hidden border-r border-dark">
        <div class="section-header px-5 py-4 bg-dark-tertiary border-b border-dark font-semibold text-muted">
            M√°quinas Virtuales
        </div>
        <div class="vm-list flex-1 overflow-y-auto p-3" id="vm-list-left"></div>
    </div>
    
    <div class="main-content w-3/5 bg-dark-primary flex flex-col overflow-hidden">
        <div class="section-header px-5 py-4 bg-dark-tertiary border-b border-dark font-semibold text-muted">
            Consola SSH
        </div>
        <div class="console-container flex-1 flex flex-col p-5 gap-4 min-h-0" id="console-container">
            <div class="no-selection flex justify-center items-center h-full text-muted italic" id="no-vm-selected">
                Selecciona una m√°quina virtual para comenzar
            </div>
        </div>
    </div>
    
    <div class="sidebar w-1/5 bg-dark-secondary flex flex-col overflow-hidden">
        <div class="section-header px-5 py-4 bg-dark-tertiary border-b border-dark font-semibold text-muted">
            Recursos del Sistema
        </div>
        <div class="resources-container p-5 flex flex-col gap-3" id="resources-container">
            <div class="no-selection flex justify-center items-center text-muted italic">
                Selecciona una m√°quina virtual para ver sus recursos
            </div>
        </div>
    </div>
</div>


<script>
// ========== 1. CONFIGURACI√ìN Y ESTADO GLOBAL ==========

const vmConfig = [
  { id: 100, name: "Ubuntu", host: "amercado.ddns.net" },
  { id: 101, name: "Windows", host: "amercado.ddns.net" },
  { id: 102, name: "Servidor Web", host: "host.para.vm.102" },
];

// ... (El resto de las variables no cambian) ...
const vmListLeft = document.getElementById('vm-list-left');
const consoleContainer = document.getElementById('console-container');
const resourcesContainer = document.getElementById('resources-container');
const noVmSelected = document.getElementById('no-vm-selected');
const noVmSelectedResources = document.querySelector('#resources-container .no-selection');

let vmStore = new Map();
let selectedVMID = null;
let terminal = null;
let fitAddon = null;
let socket = null;
let isTerminalReady = false;

let cpuProgress = null;
let ramProgress = null;


// ========== 2. L√ìGICA DE DATOS (API PROXMOX) ==========

function translateStatus(status) {
    if (status === 'running') return 'Conectado';
    if (status === 'stopped') return 'Apagada';
    if (status === 'error') return 'Error API';
    if (status === 'loading') return 'Cargando...';
    return status; 
}

function formatUptime(seconds) {
    if (!seconds || seconds <= 0) return 'Apagada';
    if (seconds < 60) return 'Hace un momento';

    const d = Math.floor(seconds / (3600 * 24));
    const h = Math.floor((seconds % (3600 * 24)) / 3600);
    const m = Math.floor((seconds % 3600) / 60);

    let parts = [];
    if (d > 0) parts.push(`${d}d`);
    if (h > 0) parts.push(`${h}h`);
    if (m > 0) parts.push(`${m}m`);
    
    if (parts.length === 0) return 'Hace un momento'; 
    return parts.join(' ');
}

/**
 * (CAMBIO) Nueva funci√≥n para formatear bytes a GB
 */
function formatBytesToGB(bytes) {
    if (!bytes || bytes === 0) return '0.0';
    const gb = bytes / (1024 * 1024 * 1024);
    return gb.toFixed(1); // 1 decimal
}


async function fetchAndRefreshData() {
    // ... (Esta funci√≥n no cambia) ...
    try {
        const response = await fetch('/api/monitor.json'); 
        if (!response.ok) {
            console.error('Error al cargar datos de la API');
            vmStore.forEach(vm => {
                if (vm.status === 'loading') vm.status = 'error';
            });
            renderVMList(); 
            return;
        }
        
        const apiDataArray = await response.json(); 
        
        apiDataArray.forEach(data => {
            const config = vmConfig.find(c => c.id === data.vmid);
            if (config) {
                const mergedVM = { ...data, host: config.host };
                vmStore.set(data.vmid, mergedVM);
            }
        });

        renderVMList();
        updateResourcesUI(); 

    } catch (error) {
        console.error('Error en fetchAndRefreshData:', error);
    }
}

function populateInitialStore() {
    // ... (Esta funci√≥n no cambia) ...
    vmStore.clear();
    vmConfig.forEach(vm => {
        vmStore.set(vm.id, {
            vmid: vm.id,
            name: vm.name,
            host: vm.host,
            status: 'loading',
            cpu: 0, mem: 0, maxmem: 1,
            disk: 0, maxdisk: 1,
            uptime: 0
        });
    });
}


// ========== 3. FUNCIONES DE UI (PANELES LATERALES) ==========

function destroyProgressBars() {
    // ... (Esta funci√≥n no cambia) ...
    if (cpuProgress) {
        cpuProgress.destroy();
        cpuProgress = null;
    }
    if (ramProgress) {
        ramProgress.destroy();
        ramProgress = null;
    }
}

function renderVMList() {
    // ... (Esta funci√≥n no cambia) ...
    if (!vmListLeft) return;
    vmListLeft.innerHTML = ''; 

    if (vmStore.size === 0) {
        vmListLeft.innerHTML = '<div class="p-4 text-muted italic">No hay VMs configuradas...</div>';
        return;
    }

    vmStore.forEach(vm => {
        const vmItem = document.createElement('div');
        vmItem.className = 'vm-item bg-dark-tertiary border-2 border-dark-accent rounded-lg p-4 mb-3 cursor-pointer transition-all duration-300 shadow-sm hover:bg-dark-accent hover:border-gray-500 hover:shadow-md';
        vmItem.dataset.id = vm.vmid;

        const statusText = translateStatus(vm.status);
        let statusClass = 'text-gray-400';
        if (vm.status === 'running') statusClass = 'text-green-400';
        else if (vm.status === 'stopped') statusClass = 'text-red-400';
        else if (vm.status === 'error') statusClass = 'text-red-500 italic';
        else if (vm.status === 'loading') statusClass = 'text-yellow-400 italic';
        
        vmItem.innerHTML = `
            <div class="vm-name font-semibold text-white mb-1">${vm.name}</div>
            <div class="vm-status text-sm">
                <span class="${statusClass}">${statusText}</span>
                <span class="text-gray-500"> ‚Ä¢ ${vm.host}</span>
            </div>
        `;
        
        vmItem.addEventListener('click', () => selectVM(vm.vmid));
        vmListLeft.appendChild(vmItem);
    });

    if (selectedVMID) {
        const selectedItem = document.querySelector(`.vm-item[data-id="${selectedVMID}"]`);
        if (selectedItem) {
            selectedItem.classList.remove('bg-dark-tertiary', 'border-dark-accent');
            selectedItem.classList.add('bg-dark-highlight', 'border-blue-400', 'shadow-lg');
        }
    }
}

/**
 * (FUNCI√ìN MODIFICADA)
 * Renderiza el panel derecho (recursos)
 */
function updateResourcesUI() {
    if (!resourcesContainer) return;

    // --- 1. Manejo de estados (Sin VM, Cargando, Error) ---
    // ... (Esta secci√≥n no cambia) ...
    if (!selectedVMID) {
        destroyProgressBars();
        resourcesContainer.innerHTML = `<div class="no-selection flex justify-center items-center text-muted italic">Selecciona una m√°quina virtual...</div>`;
        return;
    }
    const vm = vmStore.get(selectedVMID);
    if (!vm) {
        destroyProgressBars();
        resourcesContainer.innerHTML = `<div class="p-4 text-yellow-400 italic">Datos no encontrados para VM ${selectedVMID}...</div>`;
        return;
    }
    if (vm.status === 'loading') {
        destroyProgressBars();
         resourcesContainer.innerHTML = `<div class="p-4 text-yellow-400 italic">Cargando datos de recursos para ${vm.name}...</div>`;
        return;
    }
    if (vm.status === 'error') {
        destroyProgressBars();
         resourcesContainer.innerHTML = `<div class="p-4 text-red-400 italic">Error al obtener datos: <br> (${vm.error || 'Fallo de API'})</div>`;
        return;
    }

    // --- 2. C√°lculo de datos ---
    // (progressbar.js usa valores de 0.0 a 1.0)
    const cpuPercent = (vm.cpu || 0); 
    const ramPercent = ((vm.mem || 0) / (vm.maxmem || 1));
    
    // (CAMBIO) C√°lculos para el texto de Almacenamiento
    const storagePercentForBar = ((vm.disk || 0) / (vm.maxdisk || 1) * 100).toFixed(1);
    const storageUsedGB = formatBytesToGB(vm.disk || 0);
    const storageTotalGB = formatBytesToGB(vm.maxdisk || 1);
    const storageText = `${storageUsedGB} GB / ${storageTotalGB} GB`; // <-- Nuevo texto
    
    const uptime = vm.uptime || 0;
    const statusText = translateStatus(vm.status);
    const statusClass = vm.status === 'running' ? 'text-green-400' : 'text-red-400';

    // --- 3. Renderizado de HTML y Medidores ---
    
    // Si no existe, dibujamos el HTML por primera vez
    if (!cpuProgress) { 
        resourcesContainer.innerHTML = `
            <div class="resource-item bg-dark-tertiary rounded-lg p-4 border-2 border-dark-accent mb-3 shadow-sm">
                <div class="flex justify-around items-center">
                    <div class="flex flex-col items-center">
                        <div class="resource-title font-semibold text-gray-400 mb-2">CPU</div>
                        <div id="cpu-progress" class="relative w-24 h-24"></div> 
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="resource-title font-semibold text-gray-400 mb-2">RAM</div>
                        <div id="ram-progress" class="relative w-24 h-24"></div>
                    </div>
                </div>
            </div>
            
            <div class="resource-item bg-dark-tertiary rounded-lg p-4 border-2 border-dark-accent mb-3 shadow-sm">
                <div class="resource-header flex justify-between mb-3">
                    <div class="resource-title font-semibold text-gray-400">Almacenamiento</div>
                    <div id="storage-percent-text" class="resource-value text-gray-400">${storageText}</div>
                </div>
                <div class="progress-bar h-2 bg-dark-primary rounded overflow-hidden">
                    <div id="storage-bar" class="progress-fill storage-progress h-full bg-indigo-500 rounded" style="width: ${storagePercentForBar}%"></div>
                </div>
            </div>
            
            <div class="resource-item bg-dark-tertiary rounded-lg p-4 border-2 border-dark-accent mb-3 shadow-sm">
                <div class="resource-header flex justify-between">
                    <div class="resource-title font-semibold text-gray-400">Tiempo de Actividad</div>
                    <div id="uptime-text" class="resource-value text-gray-400">${formatUptime(uptime)}</div>
                </div>
            </div>
            
            <div class="resource-item bg-dark-tertiary rounded-lg p-4 border-2 border-dark-accent mb-3 shadow-sm">
                <div class="resource-header flex justify-between">
                    <div class="resource-title font-semibold text-gray-400">Estado</div>
                    <div id="status-text" class="resource-value ${statusClass}">${statusText}</div>
                </div>
            </div>
        `;
        
        // --- 4. Opciones e Inicializaci√≥n de Barras Radiales ---
        const commonProgressOptions = {
            strokeWidth: 8, 
            trailWidth: 4,  
            trailColor: '#2d3047', 
            duration: 300,
            easing: 'linear',
            text: {
                className: 'progressbar-text', 
                value: '0%'
            },
            step: (state, circle) => {
                circle.setText((circle.value() * 100).toFixed(0) + '%');
            }
        };

        cpuProgress = new ProgressBar.Circle('#cpu-progress', {
            ...commonProgressOptions,
            color: '#3b82f6', 
        });
        
        ramProgress = new ProgressBar.Circle('#ram-progress', {
            ...commonProgressOptions,
            color: '#ec4899', 
        });
    }

    // --- 5. Actualizaci√≥n de Valores ---
    if (cpuProgress) cpuProgress.animate(cpuPercent); 
    if (ramProgress) ramProgress.animate(ramPercent); 
    
    // (CAMBIO) Actualizamos los elementos de almacenamiento
    const storageBar = document.getElementById('storage-bar');
    const storageTextEl = document.getElementById('storage-percent-text');
    const uptimeText = document.getElementById('uptime-text');
    const statusTextEl = document.getElementById('status-text');

    if (storageBar) storageBar.style.width = `${storagePercentForBar}%`;
    if (storageTextEl) storageTextEl.textContent = storageText; // <-- Usamos el nuevo texto
    if (uptimeText) uptimeText.textContent = formatUptime(uptime);
    if (statusTextEl) {
        statusTextEl.textContent = statusText;
        statusTextEl.className = `resource-value ${statusClass}`;
    }
}

/**
 * Funci√≥n principal al seleccionar una VM.
 */
function selectVM(vmid) {
    // ... (Esta funci√≥n no cambia) ...
    const vm = vmStore.get(vmid);
    if (!vm) {
        console.warn(`VM con id ${vmid} no encontrada en vmStore.`);
        return;
    }

    destroyProgressBars(); 
    disconnectSSH();
    selectedVMID = vmid; 

    document.querySelectorAll('.vm-item').forEach(item => {
        item.classList.remove('bg-dark-highlight', 'border-blue-400', 'shadow-lg');
        item.classList.add('bg-dark-tertiary', 'border-dark-accent');
    });
    const selectedItem = document.querySelector(`.vm-item[data-id="${vmid}"]`);
    if (selectedItem) {
        selectedItem.classList.remove('bg-dark-tertiary', 'border-dark-accent');
        selectedItem.classList.add('bg-dark-highlight', 'border-blue-400', 'shadow-lg');
    }
    
    updateConsole(vm); 
    updateResourcesUI(); 
}


// ========== 4. FUNCIONES SSH Y DE TERMINAL (SIN CAMBIOS) ==========

function updateConnectionStatus(status, color) {
    // ... (Esta funci√≥n no cambia) ...
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
        statusElement.textContent = status;
        statusElement.className = `text-${color}-400`;
    }
}

function safeTerminalWrite(message) {
    // ... (Esta funci√≥n no cambia) ...
    if (terminal && isTerminalReady) {
        terminal.write(message);
        return true;
    } else {
        console.warn('Terminal no disponible:', message);
        return false;
    }
}

function initializeTerminal() {
    // ... (Esta funci√≥n no cambia) ...
    return new Promise((resolve, reject) => {
        try {
            if (terminal) {
                terminal.dispose();
                terminal = null;
                isTerminalReady = false;
            }
            const terminalElement = document.getElementById('terminal');
            if (!terminalElement) {
                reject(new Error('Elemento terminal no encontrado en el DOM'));
                return;
            }
            terminal = new Terminal({
                cursorBlink: true,
                theme: {
                    background: '#000000',
                    foreground: '#00ff00',
                    cursor: '#00ff00'
                },
                fontSize: 14,
                fontFamily: 'Courier New, monospace'
            });
            fitAddon = new FitAddon.FitAddon();
            terminal.loadAddon(fitAddon);
            terminal.open(terminalElement);
            setTimeout(() => {
                try {
                    fitAddon.fit();
                    isTerminalReady = true;
                    console.log('‚úÖ Terminal inicializada correctamente');
                    resolve(terminal);
                } catch (fitError) {
                    console.warn('Error ajustando terminal:', fitError);
                    isTerminalReady = true;
                    resolve(terminal);
                }
            }, 100);
            window.addEventListener('resize', () => {
                if (fitAddon && isTerminalReady) {
                    try {
                        fitAddon.fit();
                    } catch (e) {
                        console.warn('Error redimensionando terminal:', e);
                    }
                }
            });
        } catch (error) {
            console.error('‚ùå Error inicializando terminal:', error);
            isTerminalReady = false;
            reject(error);
        }
    });
}

function updateConsole(vm) {
    // ... (Esta funci√≥n no cambia) ...
    if (!consoleContainer || !noVmSelected) return;
    noVmSelected.style.display = 'none';
    
    consoleContainer.innerHTML = `
        <div class="console-header flex justify-between items-center mb-4">
            <div class="console-title text-xl font-semibold text-gray-400">
                Conexi√≥n SSH: ${vm.name} (${vm.host})
            </div>
            <div class="console-actions">
                <button class="connect-btn bg-green-600 border-none text-white px-4 py-2 rounded cursor-pointer ml-3 hover:bg-green-700 transition-colors">
                    Conectar
                </button>
                <button class="disconnect-btn bg-red-600 border-none text-white px-4 py-2 rounded cursor-pointer ml-3 hover:bg-red-700 transition-colors">
                    Desconectar
                </button>
            </div>
        </div>
        <div class="terminal-container flex-1 bg-black rounded-lg border border-gray-600 overflow-hidden p-2.5" style="min-height: 0;">
            <div id="terminal" class="h-full w-full"></div>
        </div>
        <div class="console-status text-sm text-gray-400 mt-2">
            Estado: <span id="connection-status" class="text-red-400">Desconectado</span>
        </div>
    `;
    
    setTimeout(async () => {
        try {
            await initializeTerminal();
            console.log('Terminal lista para usar');
        } catch (error) {
            console.error('Error inicializando terminal en updateConsole:', error);
        }
    }, 50);

    setTimeout(() => {
        const connectBtn = document.querySelector('.connect-btn');
        const disconnectBtn = document.querySelector('.disconnect-btn');
        if (connectBtn) {
            connectBtn.onclick = () => connectSSH(vm);
        }
        if (disconnectBtn) {
            disconnectBtn.onclick = disconnectSSH;
        }
    }, 100);
}

async function connectSSH(vm) {
    // ... (Esta funci√≥n no cambia) ...
    if (!vm) {
        console.error('No hay m√°quina virtual seleccionada');
        return;
    }
    if (!isTerminalReady) {
        try {
            await initializeTerminal();
        } catch (error) {
            console.error('No se pudo inicializar la terminal:', error);
            return;
        }
    }
    safeTerminalWrite(`\r\n\x1b[1;33müîÑ Conectando a ${vm.name}...\x1b[0m\r\n`);
    safeTerminalWrite(`\x1b[1;33müåê DNS: ${vm.host}\x1b[0m\r\n`);
    
    try {
        const response = await fetch('http://localhost:3001/health');
        if (!response.ok) throw new Error('Backend no responde');
        safeTerminalWrite('\x1b[1;32m‚úÖ Backend disponible\x1b[0m\r\n');
    } catch (error) {
        safeTerminalWrite(`\x1b[1;31m‚ùå Error: ${error.message}\x1b[0m\r\n`);
        safeTerminalWrite('\x1b[1;33müí° Aseg√∫rate de que el servidor backend est√© ejecut√°ndose\x1b[0m\r\n');
        return;
    }
    
    const backendUrl = 'ws://localhost:3001/ssh';
    socket = new WebSocket(backendUrl);
    
    socket.onopen = () => {
        safeTerminalWrite('\x1b[1;32m‚úÖ Conexi√≥n WebSocket establecida\x1b[0m\r\n');
        safeTerminalWrite('\x1b[1;33müîê Autenticando...\x1b[0m\r\n');
        updateConnectionStatus('Conectando...', 'yellow');
        
        socket.send(JSON.stringify({
            type: 'connect',
            vmId: vm.vmid
        }));
    };
    
    socket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'output') {
                safeTerminalWrite(data.data);
            } else if (data.type === 'status') {
                safeTerminalWrite(`\r\n\x1b[1;36m${data.message}\x1b[0m\r\n`);
                updateConnectionStatus('Conectado', 'green');
            } else if (data.type === 'error') {
                safeTerminalWrite(`\r\n\x1b[1;31m‚ùå ${data.message}\x1b[0m\r\n`);
                updateConnectionStatus('Error', 'red');
            }
        } catch (error) {
            console.error('Error parsing message:', error);
        }
    };
    
    socket.onclose = (event) => {
        const message = event.code === 1000 ?
            '\r\n\x1b[1;33müîå Conexi√≥n cerrada\x1b[0m\r\n' : 
            `\r\n\x1b[1;31m‚ùå Conexi√≥n cerrada (c√≥digo ${event.code})\x1b[0m\r\n`;
        safeTerminalWrite(message);
        updateConnectionStatus('Desconectado', 'red');
    };
    
    socket.onerror = (error) => {
        safeTerminalWrite('\r\n\x1b[1;31m‚ùå Error de conexi√≥n WebSocket\x1b[0m\r\n');
        updateConnectionStatus('Error de conexi√≥n', 'red');
    };
    
    if (terminal && isTerminalReady) {
        terminal.onData((data) => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'input',
                    data: data
                }));
            }
        });
    }
}

function disconnectSSH() {
    // ... (Esta funci√≥n no cambia) ...
    if (socket) {
        socket.close();
        socket = null;
    }
    safeTerminalWrite('\r\n\x1b[1;33müîå Desconectado por el usuario\x1b[0m\r\n');
    updateConnectionStatus('Desconectado', 'red');
}


// ========== 5. INICIALIZACI√ìN ==========

document.addEventListener('DOMContentLoaded', () => {
    // ... (Esta funci√≥n no cambia) ...
    console.log('üöÄ Inicializando aplicaci√≥n SSH...');
    
    populateInitialStore();
    renderVMList();
    fetchAndRefreshData();
    setInterval(fetchAndRefreshData, 5000);
});
</script>