---

const { user, posts } = Astro.props;

// Transformar posts igual que antes
const allPostsData = posts.map((post) => ({
  id: post.id,
  title: post.title,
  content: post.content,
  category: post.category ?? "General",
  views: post.views ?? 0,
  author: post.author,
  commentCount: post.comments.length,
  comments: post.comments,
  groupedReactions: post.reactions.reduce((acc, r) => {
    acc[r.type] = (acc[r.type] || 0) + 1;
    return acc;
  }, {})
}));

const userPostsData = allPostsData.filter(
  (p) => p.author.username === user.username
);

const userCommentsData = posts
  .flatMap(p => p.comments)
  .filter(c => c.author.username === user.username)
  .map(c => ({
    ...c,
    post: posts.find(p => p.id === c.postId)
  }));

const trendingPosts = allPostsData
  .sort((a, b) => b.views - a.views)
  .slice(0, 3);

---

<main class="flex flex-col md:flex-row gap-6 p-4 md:p-8 text-white min-h-screen">
  
  <!-- Perfil -->

  <aside class="w-full md:w-1/5 flex-shrink-0">

    <!-- BotÃ³n para crear nuevo post -->
     
    <div class="flex justify-end">
      <a
        href="/crear-post"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition shadow"
      >
        âž• Crear nuevo post
      </a>
    </div>

    <div class="bg-gray-900 p-6 rounded-lg sticky top-8">
      <h2 class="text-2xl font-bold mb-2">{user.username}</h2>
      <p class="text-gray-400 mb-4">{user.bio}</p>
      <p class="text-sm text-gray-500 italic">Miembro desde 2023</p>
    </div>
  </aside>

  <!-- Contenido principal -->
  <section id="content-container" class="w-full md:w-3/5 space-y-6">

  {allPostsData.map(post => (
    <article
      data-post-id={post.id}
      class="bg-gray-900 rounded-lg p-6 border border-gray-900 cursor-pointer transition-all duration-200 hover:border-[#64ffd6] hover:shadow-lg"
    >
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-2xl font-bold text-blue-400">{post.title}</h3>
        <span class="bg-blue-700 text-xs uppercase px-3 py-1 rounded-full">{post.category}</span>
      </div>
      <p class="text-sm text-gray-500 mb-4">
        Publicado por {post.author.username} Â· {post.views} vistas
      </p>
      <p class="text-gray-300 whitespace-pre-line">{post.content}</p>
      <div class="mt-4 flex items-center gap-4 text-gray-400">
        <div class="flex items-center gap-2">
          <span>ðŸ’¬</span><span>{post.commentCount} comentarios</span>
        </div>
        <div class="flex items-center gap-3">
          {Object.entries(post.groupedReactions).map(([emoji, count]) => (
            <div class="flex items-center gap-1 bg-gray-700 px-2 py-1 rounded-full text-sm">
              <span>{emoji}</span><span>{count}</span>
            </div>
          ))}
        </div>
      </div>
    </article>
  ))}
</section>


  <!-- Filtros y tendencias -->
  <aside class="w-full md:w-1/5 flex-shrink-0">
    <div class="bg-gray-900 p-6 rounded-lg sticky top-8 space-y-6">
      <div>
        <h2 class="text-xl font-semibold border-b border-gray-900 pb-2">Filtros</h2>
        <button id="show-all-btn" class="w-full text-left bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-t mt-3">Todas las publicaciones</button>
        <button id="show-posts-btn" class="w-full text-left bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4">Mis publicaciones</button>
        <button id="show-comments-btn" class="w-full text-left bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-b">Mis comentarios</button>
      </div>

      <div>
        <h3 class="text-xl font-semibold border-b border-gray-800 pb-2">Tendencias</h3>
        <ul class="mt-3 space-y-3">
          {trendingPosts.map(post => (
            <li class="bg-gray-800 hover:bg-gray-700 transition rounded-lg p-3">
              <p class="text-blue-400 font-semibold text-sm">{post.title}</p>
              <p class="text-gray-400 text-xs">{post.views} vistas Â· {post.commentCount} comentarios</p>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </aside>
</main>

<script define:vars={{ allPostsData, userPostsData, userCommentsData }}>
  const contentContainer = document.getElementById('content-container');
  const showAllBtn = document.getElementById('show-all-btn');
  const showPostsBtn = document.getElementById('show-posts-btn');
  const showCommentsBtn = document.getElementById('show-comments-btn');

  // ðŸ”¥ LO QUE SIGUE SE MANTIENE (renderizado del frontend)
  // no cambiÃ© nada excepto que ahora usa datos reales

  const renderPosts = (posts) => {
    if (posts.length === 0) {
      return `<div class="bg-gray-800 text-center p-8 rounded-lg"><p class="text-gray-400">No hay publicaciones para mostrar.</p></div>`;
    }
    return posts.map(post => `
      <article data-post-id="${post.id}" class="bg-gray-800 rounded-lg p-6 border border-gray-700 cursor-pointer transition-all duration-200 hover:border-blue-500 hover:shadow-lg">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold text-blue-400">${post.title}</h3>
          <span class="bg-blue-700 text-xs uppercase px-3 py-1 rounded-full">${post.category}</span>
        </div>
        <p class="text-sm text-gray-500 mb-4">Publicado por ${post.author.username} Â· ${post.views} vistas</p>
        <p class="text-gray-300 whitespace-pre-line">${post.content}</p>
        <div class="mt-4 flex items-center gap-4 text-gray-400">
          <div class="flex items-center gap-2"><span>ðŸ’¬</span><span>${post.commentCount} comentarios</span></div>
          <div class="flex items-center gap-3">
            ${Object.entries(post.groupedReactions).map(([emoji, count]) => `
              <div class="flex items-center gap-1 bg-gray-700 px-2 py-1 rounded-full text-sm"><span>${emoji}</span><span>${count}</span></div>`).join('')}
          </div>
        </div>
      </article>
    `).join('');
  };

  const renderPostDetail = (postId) => {
    const post = allPostsData.find(p => p.id === postId);
    if (!post) {
      contentContainer.innerHTML = '<p>Post no encontrado.</p>';
      return;
    }
    const commentsHtml = post.comments.length > 0
      ? post.comments.map(c => `<div class="bg-gray-700 p-4 rounded-lg flex gap-4"><div class="font-bold text-blue-400">${c.author.username}:</div><div class="text-gray-300">${c.content}</div></div>`).join('')
      : '<p class="text-gray-500">No hay comentarios aÃºn.</p>';
    contentContainer.innerHTML = `
      <div>
        <button onclick="renderInitialView()" class="mb-6 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors duration-200">&larr; Volver</button>
        <article class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-3xl font-bold text-blue-400">${post.title}</h3>
            <span class="bg-blue-700 text-xs uppercase px-3 py-1 rounded-full">${post.category}</span>
          </div>
          <p class="text-sm text-gray-500 mb-4">Publicado por ${post.author.username} Â· ${post.views} vistas</p>
          <p class="text-gray-300 text-lg whitespace-pre-line">${post.content}</p>
          <div class="mt-6 flex items-center gap-3">
            ${Object.entries(post.groupedReactions).map(([emoji, count]) => `
              <div class="flex items-center gap-1 bg-gray-700 px-2 py-1 rounded-full text-sm"><span>${emoji}</span><span>${count}</span></div>`).join('')}
          </div>
        </article>
        <div class="mt-8">
          <h4 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Comentarios</h4>
          <div class="space-y-4">${commentsHtml}</div>
        </div>
      </div>`;
  };

  const renderComments = (comments) => {
    if (comments.length === 0) {
      return `<div class="bg-gray-800 text-center p-8 rounded-lg"><p class="text-gray-400">No tienes comentarios.</p></div>`;
    }
    return comments.map(comment => `
      <article class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <p class="text-gray-400 text-sm mb-3">Tu comentario en <span class="font-bold text-blue-400">"${comment.post.title}"</span></p>
        <div class="bg-gray-900 p-4 rounded"><p class="text-gray-300">${comment.content}</p></div>
      </article>`).join('');
  };

  const renderInitialView = () => { contentContainer.innerHTML = renderPosts(allPostsData); };
  window.renderInitialView = renderInitialView;

  showAllBtn.addEventListener('click', renderInitialView);
  showPostsBtn.addEventListener('click', () => contentContainer.innerHTML = renderPosts(userPostsData));
  showCommentsBtn.addEventListener('click', () => contentContainer.innerHTML = renderComments(userCommentsData));

  contentContainer.addEventListener('click', (event) => {
    const postArticle = event.target.closest('article[data-post-id]');
    if (postArticle) {
      const postId = parseInt(postArticle.dataset.postId, 10);
      renderPostDetail(postId);
    }
  });
</script>
