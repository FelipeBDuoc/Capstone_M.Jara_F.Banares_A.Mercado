---
// src/components/Foro.astro

// --- SIMULACIÃ“N EXTENDIDA DE DATOS ---
const users = [
  { id: 1, username: "SirWilinston", bio: "Desarrollador y entusiasta de Astro." },
  { id: 2, username: "AstroFan", bio: "Explorando el cosmos de la web." },
  { id: 3, username: "CodeLuna", bio: "Frontend dev amante de la accesibilidad." },
  { id: 4, username: "DevNova", bio: "DiseÃ±ador y programador full-stack." },
  { id: 5, username: "PixelOrbit", bio: "FanÃ¡tico de los UI components." }
];

const posts = [
  { id: 101, title: "Â¿CuÃ¡l es su caracterÃ­stica favorita de Astro?", category: "DiscusiÃ³n General", content: "Personalmente, me encantan las Astro Islands. La capacidad de enviar cero JavaScript por defecto es revolucionaria. Â¿QuÃ© opinan ustedes?", authorId: 1, views: 324 },
  { id: 102, title: "Proyecto con TailwindCSS y Astro", category: "Proyectos", content: "Estoy empezando un nuevo proyecto y la combinaciÃ³n de Astro con Tailwind es increÃ­blemente rÃ¡pida para prototipar. Â¿Alguien mÃ¡s lo usa?", authorId: 2, views: 278 },
  { id: 103, title: "Manejo de estado en Astro", category: "Ayuda y Soporte", content: "He estado investigando sobre cÃ³mo manejar el estado global. Â¿QuÃ© herramientas (Nanostores, SolidJS stores, etc.) recomiendan para un proyecto mediano?", authorId: 1, views: 512 },
  { id: 104, title: "IntegraciÃ³n con CMS Headless", category: "Integraciones", content: "Estoy probando Sanity y Contentful con Astro. Â¿CuÃ¡l creen que tiene mejor rendimiento y flexibilidad?", authorId: 3, views: 231 },
  { id: 105, title: "Nuevo tema oscuro para mi blog Astro", category: "DiseÃ±o", content: "Acabo de implementar un modo oscuro personalizado usando CSS variables. Si quieren les comparto el snippet.", authorId: 5, views: 417 }
];

const comments = [
  { id: 201, content: "Totalmente de acuerdo, Â¡las islas son geniales!", authorId: 2, postId: 101 },
  { id: 202, content: "Â¡SÃ­! Lo uso en todos mis proyectos. La purga de CSS automÃ¡tica es una maravilla.", authorId: 1, postId: 102 },
  { id: 203, content: "He probado Nanostores y es sÃºper ligero y fÃ¡cil de integrar.", authorId: 2, postId: 103 },
  { id: 204, content: "Â¡Buena pregunta! TambiÃ©n estoy interesado en esto.", authorId: 2, postId: 101 },
  { id: 205, content: "Prefiero Contentful, su API GraphQL es mÃ¡s flexible.", authorId: 4, postId: 104 },
  { id: 206, content: "El diseÃ±o oscuro se ve genial, muy limpio.", authorId: 3, postId: 105 },
  { id: 207, content: "Sanity tiene un panel mÃ¡s intuitivo, aunque Contentful es mÃ¡s robusto.", authorId: 1, postId: 104 },
  { id: 208, content: "Â¿PodrÃ­as compartir el cÃ³digo del tema oscuro?", authorId: 2, postId: 105 }
];

const reactions = [
  { id: 301, type: 'ðŸ‘', userId: 2, postId: 101 },
  { id: 302, type: 'ðŸš€', userId: 1, postId: 101 },
  { id: 303, type: 'â¤ï¸', userId: 1, postId: 102 },
  { id: 304, type: 'ðŸ‘', userId: 2, postId: 103 },
  { id: 305, type: 'ðŸ¤”', userId: 1, postId: 103 },
  { id: 306, type: 'ðŸ”¥', userId: 5, postId: 105 },
  { id: 307, type: 'ðŸ’¡', userId: 3, postId: 104 },
  { id: 308, type: 'ðŸ‘', userId: 4, postId: 105 },
  { id: 309, type: 'â¤ï¸', userId: 2, postId: 104 }
];

// --- PROCESAMIENTO DE DATOS ---
const currentUser = users.find(u => u.username === "SirWilinston");

const enrichPosts = (postList) => {
  return postList.map(post => {
    const author = users.find(u => u.id === post.authorId);
    const enrichedComments = comments
      .filter(c => c.postId === post.id)
      .map(comment => ({
        ...comment,
        author: users.find(u => u.id === comment.authorId)
      }));
    const postReactions = reactions.filter(r => r.postId === post.id);
    const groupedReactions = postReactions.reduce((acc, reaction) => {
      acc[reaction.type] = (acc[reaction.type] || 0) + 1;
      return acc;
    }, {});
    return {
      ...post,
      author,
      commentCount: enrichedComments.length,
      groupedReactions,
      comments: enrichedComments
    };
  });
};

const allPostsData = enrichPosts(posts);
const userPostsData = enrichPosts(posts.filter(p => p.authorId === currentUser.id));
const userCommentsData = comments
  .filter(c => c.authorId === currentUser.id)
  .map(comment => ({
    ...comment,
    post: posts.find(p => p.id === comment.postId)
  }));

const trendingPosts = allPostsData
  .sort((a, b) => b.views - a.views)
  .slice(0, 3);
---

<main class="flex flex-col md:flex-row gap-6 p-4 md:p-8 bg-gray-900 text-white min-h-screen">
  <!-- Perfil -->
  <aside class="w-full md:w-1/5 flex-shrink-0">
    <div class="bg-gray-800 p-6 rounded-lg sticky top-8">
      <h2 class="text-2xl font-bold mb-2">{currentUser.username}</h2>
      <p class="text-gray-400 mb-4">{currentUser.bio}</p>
      <p class="text-sm text-gray-500 italic">Miembro desde 2023</p>
    </div>
  </aside>

  <!-- Contenido principal -->
  <section id="content-container" class="w-full md:w-3/5 space-y-6">
    {allPostsData.map(post => (
      <article
        data-post-id={post.id}
        class="bg-gray-800 rounded-lg p-6 border border-gray-700 cursor-pointer transition-all duration-200 hover:border-blue-500 hover:shadow-lg"
      >
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold text-blue-400">{post.title}</h3>
          <span class="bg-blue-700 text-xs uppercase px-3 py-1 rounded-full">{post.category}</span>
        </div>
        <p class="text-sm text-gray-500 mb-4">
          Publicado por {post.author.username} Â· {post.views} vistas
        </p>
        <p class="text-gray-300 whitespace-pre-line">{post.content}</p>
        <div class="mt-4 flex items-center gap-4 text-gray-400">
          <div class="flex items-center gap-2">
            <span>ðŸ’¬</span><span>{post.commentCount} comentarios</span>
          </div>
          <div class="flex items-center gap-3">
            {Object.entries(post.groupedReactions).map(([emoji, count]) => (
              <div class="flex items-center gap-1 bg-gray-700 px-2 py-1 rounded-full text-sm">
                <span>{emoji}</span><span>{count}</span>
              </div>
            ))}
          </div>
        </div>
      </article>
    ))}
  </section>

  <!-- Filtros y tendencias -->
  <aside class="w-full md:w-1/5 flex-shrink-0">
    <div class="bg-gray-800 p-6 rounded-lg sticky top-8 space-y-6">
      <div>
        <h2 class="text-xl font-semibold border-b border-gray-700 pb-2">Filtros</h2>
        <button id="show-all-btn" class="w-full text-left bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-3">Todas las publicaciones</button>
        <button id="show-posts-btn" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Mis publicaciones</button>
        <button id="show-comments-btn" class="w-full text-left bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Mis comentarios</button>
      </div>

      <div>
        <h3 class="text-xl font-semibold border-b border-gray-700 pb-2">Tendencias</h3>
        <ul class="mt-3 space-y-3">
          {trendingPosts.map(post => (
            <li class="bg-gray-700 hover:bg-gray-600 transition rounded-lg p-3">
              <p class="text-blue-400 font-semibold text-sm">{post.title}</p>
              <p class="text-gray-400 text-xs">{post.views} vistas Â· {post.commentCount} comentarios</p>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </aside>
</main>

<script define:vars={{ allPostsData, userPostsData, userCommentsData }}>
  const contentContainer = document.getElementById('content-container');
  const showAllBtn = document.getElementById('show-all-btn');
  const showPostsBtn = document.getElementById('show-posts-btn');
  const showCommentsBtn = document.getElementById('show-comments-btn');

  const renderPosts = (posts) => {
    if (posts.length === 0) {
      return `<div class="bg-gray-800 text-center p-8 rounded-lg"><p class="text-gray-400">No hay publicaciones para mostrar.</p></div>`;
    }
    return posts.map(post => `
      <article data-post-id="${post.id}" class="bg-gray-800 rounded-lg p-6 border border-gray-700 cursor-pointer transition-all duration-200 hover:border-blue-500 hover:shadow-lg">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold text-blue-400">${post.title}</h3>
          <span class="bg-blue-700 text-xs uppercase px-3 py-1 rounded-full">${post.category}</span>
        </div>
        <p class="text-sm text-gray-500 mb-4">Publicado por ${post.author.username} Â· ${post.views} vistas</p>
        <p class="text-gray-300 whitespace-pre-line">${post.content}</p>
        <div class="mt-4 flex items-center gap-4 text-gray-400">
          <div class="flex items-center gap-2"><span>ðŸ’¬</span><span>${post.commentCount} comentarios</span></div>
          <div class="flex items-center gap-3">
            ${Object.entries(post.groupedReactions).map(([emoji, count]) => `
              <div class="flex items-center gap-1 bg-gray-700 px-2 py-1 rounded-full text-sm"><span>${emoji}</span><span>${count}</span></div>`).join('')}
          </div>
        </div>
      </article>
    `).join('');
  };

  const renderPostDetail = (postId) => {
    const post = allPostsData.find(p => p.id === postId);
    if (!post) {
      contentContainer.innerHTML = '<p>Post no encontrado.</p>';
      return;
    }
    const commentsHtml = post.comments.length > 0
      ? post.comments.map(c => `<div class="bg-gray-700 p-4 rounded-lg flex gap-4"><div class="font-bold text-blue-400">${c.author.username}:</div><div class="text-gray-300">${c.content}</div></div>`).join('')
      : '<p class="text-gray-500">No hay comentarios aÃºn.</p>';
    contentContainer.innerHTML = `
      <div>
        <button onclick="renderInitialView()" class="mb-6 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-colors duration-200">&larr; Volver</button>
        <article class="bg-gray-800 rounded-lg p-6 border border-gray-700">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-3xl font-bold text-blue-400">${post.title}</h3>
            <span class="bg-blue-700 text-xs uppercase px-3 py-1 rounded-full">${post.category}</span>
          </div>
          <p class="text-sm text-gray-500 mb-4">Publicado por ${post.author.username} Â· ${post.views} vistas</p>
          <p class="text-gray-300 text-lg whitespace-pre-line">${post.content}</p>
          <div class="mt-6 flex items-center gap-3">
            ${Object.entries(post.groupedReactions).map(([emoji, count]) => `
              <div class="flex items-center gap-1 bg-gray-700 px-2 py-1 rounded-full text-sm"><span>${emoji}</span><span>${count}</span></div>`).join('')}
          </div>
        </article>
        <div class="mt-8">
          <h4 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Comentarios</h4>
          <div class="space-y-4">${commentsHtml}</div>
        </div>
      </div>`;
  };

  const renderComments = (comments) => {
    if (comments.length === 0) {
      return `<div class="bg-gray-800 text-center p-8 rounded-lg"><p class="text-gray-400">No tienes comentarios.</p></div>`;
    }
    return comments.map(comment => `
      <article class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <p class="text-gray-400 text-sm mb-3">Tu comentario en <span class="font-bold text-blue-400">"${comment.post.title}"</span></p>
        <div class="bg-gray-900 p-4 rounded"><p class="text-gray-300">${comment.content}</p></div>
      </article>`).join('');
  };

  const renderInitialView = () => { contentContainer.innerHTML = renderPosts(allPostsData); };
  window.renderInitialView = renderInitialView;

  showAllBtn.addEventListener('click', renderInitialView);
  showPostsBtn.addEventListener('click', () => contentContainer.innerHTML = renderPosts(userPostsData));
  showCommentsBtn.addEventListener('click', () => contentContainer.innerHTML = renderComments(userCommentsData));

  contentContainer.addEventListener('click', (event) => {
    const postArticle = event.target.closest('article[data-post-id]');
    if (postArticle) {
      const postId = parseInt(postArticle.dataset.postId, 10);
      renderPostDetail(postId);
    }
  });
</script>
