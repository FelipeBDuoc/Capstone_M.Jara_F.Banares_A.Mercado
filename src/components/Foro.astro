---
const { user, posts } = Astro.props;

// --- VALIDACIONES DE USUARIO ---
const userBio = user.bio && user.bio.trim() !== "" 
  ? user.bio 
  : "Este usuario prefiere mantener el misterio.";

let memberSince = "N/A";
if (user.createdAt) {
  try {
    memberSince = new Date(user.createdAt).toLocaleDateString('es-ES', { year: 'numeric' });
  } catch (e) { memberSince = "N/A"; }
}

// --- TRANSFORMACI√ìN DE DATOS (Incluyendo Media y Reacciones del usuario actual) ---
const allPostsData = posts.map((post) => {
  // Verificamos qu√© reacci√≥n puso el usuario actual (si existe)
  const myReaction = post.reactions.find(r => r.userId === user.id)?.type || null;

  return {
    id: post.id,
    title: post.title,
    content: post.content,
    category: "General", // Ajusta si tienes categor√≠as en DB
    views: 0, // Ajusta si tienes views
    author: post.author,
    commentCount: post.comments.length,
    comments: post.comments,
    media: post.media || [], // Array de fotos/videos
    myReaction: myReaction,  // La reacci√≥n del usuario logueado
    groupedReactions: post.reactions.reduce((acc, r) => {
      acc[r.type] = (acc[r.type] || 0) + 1;
      return acc;
    }, {})
  };
});

const userPostsData = allPostsData.filter((p) => p.author.username === user.username);
const userCommentsData = posts.flatMap(p => p.comments).filter(c => c.author.username === user.username).map(c => ({...c, post: posts.find(p => p.id === c.postId)}));
const trendingPosts = allPostsData.sort((a, b) => b.commentCount - a.commentCount).slice(0, 3);
---

<main class="flex flex-col md:flex-row gap-6 p-4 md:p-8 text-white min-h-screen relative caret-transparent">
  
  <aside class="w-full md:w-1/5 flex-shrink-0">
    <div class="flex justify-end mb-4">
      <button id="open-modal-btn" class="bg-[#00ffbb] hover:bg-white text-black px-4 py-2 rounded-lg font-bold transition shadow-lg shadow-[#00ffbb]/20 w-full md:w-auto">
        ‚ûï Crear nuevo post
      </button>
    </div>
    <div class="relative border border-[#64ffd6] shadow-xl shadow-[#00ffbb]/25 bg-gray-900 p-6 rounded-lg sticky top-8">
      <h2 class="text-2xl font-bold mb-2 text-[#00ffbb]">{user.username}</h2>
      <p class="text-gray-300 mb-4 italic text-sm">{userBio}</p>
      <p class="text-sm text-gray-500 font-bold">Miembro desde {memberSince}</p>
    </div>
  </aside>

  <section id="content-container" class="w-full md:w-3/5 space-y-6">
    <div class="text-center text-[#00ffbb] animate-pulse">Cargando foro...</div>
  </section>

  <aside class="w-full md:w-1/5 flex-shrink-0">
    <div class="relative border border-[#64ffd6] shadow-xl shadow-[#00ffbb]/25 bg-gray-900 p-6 rounded-lg sticky top-8 space-y-6">
      <div>
        <h2 class="text-xl font-semibold border-b border-[#00ffbb]/30 text-[#00ffbb] pb-2">Filtros</h2>
        <div class="flex flex-col mt-3 gap-1">
          <button id="show-all-btn" class="w-full text-left p-2 rounded hover:bg-[#00ffbb] hover:text-black transition-colors font-semibold text-gray-300">Todas las publicaciones</button>
          <button id="show-posts-btn" class="w-full text-left p-2 rounded hover:bg-[#00ffbb] hover:text-black transition-colors font-semibold text-gray-300">Mis publicaciones</button>
          <button id="show-comments-btn" class="w-full text-left p-2 rounded hover:bg-[#00ffbb] hover:text-black transition-colors font-semibold text-gray-300">Mis comentarios</button>
        </div>
      </div>
      <div>
        <h3 class="text-xl font-semibold border-b border-[#00ffbb]/30 text-[#00ffbb] pb-2">Tendencias</h3>
        <ul class="mt-3 space-y-3">
          {trendingPosts.map(post => (
            <li class="bg-gray-800 hover:bg-gray-700 transition rounded-lg p-3 border border-transparent hover:border-[#00ffbb]/50 cursor-pointer">
              <p class="text-[#00ffbb] font-semibold text-sm">{post.title}</p>
              <p class="text-gray-400 text-xs">{post.commentCount} comentarios</p>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </aside>

  <div id="create-post-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="modal-backdrop"></div>
    <div class="relative bg-gray-900 p-8 rounded-xl shadow-2xl border border-[#64ffd6] shadow-[#00ffbb]/30 w-full max-w-2xl mx-4">
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-[#00ffbb]">‚úï</button>
      <h2 class="text-3xl font-bold text-[#00ffbb] mb-6 border-b border-[#00ffbb]/30 pb-2">Crear nueva publicaci√≥n</h2>
      
      <form action="/api/posts/create" method="POST" enctype="multipart/form-data" class="space-y-5">
        <div>
          <label class="block mb-2 font-bold text-[#00ffbb]">T√≠tulo</label>
          <input type="text" name="title" required class="w-full px-4 py-3 rounded bg-[#111] border border-gray-700 focus:border-[#00ffbb] text-white outline-none caret-[#00ffbb]" />
        </div>
        <div>
          <label class="block mb-2 font-bold text-[#00ffbb]">Contenido</label>
          <textarea name="content" rows="4" required class="w-full px-4 py-3 rounded bg-[#111] border border-gray-700 focus:border-[#00ffbb] text-white outline-none caret-[#00ffbb] resize-none"></textarea>
        </div>
        
        <div>
          <label class="block mb-2 font-bold text-[#00ffbb]">Multimedia (Fotos o Videos)</label>
          <input 
            type="file" 
            name="media" 
            multiple 
            accept="image/*,video/*"
            class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#00ffbb] file:text-black hover:file:bg-white transition"
          />
        </div>

        <input type="hidden" name="authorId" value={user.id} />
        <button type="submit" class="w-full bg-[#00ffbb] hover:bg-white text-black py-3 rounded-lg font-bold shadow-lg shadow-[#00ffbb]/20 transition-all">Publicar</button>
      </form>
    </div>
  </div>
</main>

<script define:vars={{ allPostsData, userPostsData, userCommentsData, currentUserId: user.id }}>
  const contentContainer = document.getElementById('content-container');
  const showAllBtn = document.getElementById('show-all-btn');
  const showPostsBtn = document.getElementById('show-posts-btn');
  const showCommentsBtn = document.getElementById('show-comments-btn');

  // --- AYUDANTE: Renderizar Media (Grid de im√°genes/videos) ---
  const renderMediaGrid = (mediaFiles) => {
    if (!mediaFiles || mediaFiles.length === 0) return '';
    return `
      <div class="grid grid-cols-2 gap-2 mt-4 mb-4 rounded-lg overflow-hidden">
        ${mediaFiles.map(m => {
          if (m.type === 'VIDEO') {
            return `<video controls class="w-full h-48 object-cover bg-black"><source src="${m.url}"></video>`;
          }
          return `<img src="${m.url}" class="w-full h-48 object-cover hover:scale-105 transition duration-500" loading="lazy" />`;
        }).join('')}
      </div>
    `;
  };

  // --- AYUDANTE: Botonera de Reacciones ---
  const renderReactionButtons = (post) => {
    const emojis = { 'LIKE': 'üëç', 'LOVE': '‚ù§Ô∏è', 'FUNNY': 'üòÇ', 'WOW': 'üòÆ' };
    
    return `
      <div class="flex gap-2 mt-2" onclick="event.stopPropagation()">
        ${Object.entries(emojis).map(([type, icon]) => {
          // Si es la reacci√≥n actual del usuario, la pintamos rellena/brillante
          const isActive = post.myReaction === type; 
          const activeClass = isActive ? 'bg-[#00ffbb] text-black scale-110' : 'bg-gray-800 text-gray-400 hover:bg-gray-700';
          
          return `
            <button 
              onclick="handleReaction(${post.id}, '${type}')"
              class="px-3 py-1 rounded-full text-lg transition-all border border-transparent hover:border-[#00ffbb]/50 ${activeClass}"
              title="${type}"
            >
              ${icon}
            </button>
          `;
        }).join('')}
      </div>
    `;
  };

  // --- FUNCI√ìN PRINCIPAL: Renderizar Lista de Posts ---
  const renderPosts = (posts) => {
    if (posts.length === 0) return `<div class="bg-gray-800 text-center p-8 rounded-lg"><p class="text-gray-400">No hay publicaciones.</p></div>`;
    
    return posts.map(post => `
      <article data-post-id="${post.id}" class="relative bg-gray-900 rounded-lg p-6 border border-[#64ffd6]/50 shadow-md shadow-[#00ffbb]/10 cursor-pointer transition-all duration-300 hover:border-[#00ffbb] group mb-6">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold text-[#00ffbb] group-hover:text-white transition-colors">${post.title}</h3>
        </div>
        <p class="text-sm text-gray-400 mb-4">Por <span class="text-white font-bold">${post.author.username}</span></p>
        
        <p class="text-gray-300 whitespace-pre-line mb-2">${post.content}</p>
        
        ${renderMediaGrid(post.media)}

        <div class="mt-4 flex flex-col gap-3 border-t border-gray-800 pt-4">
          <div class="flex justify-between items-center text-gray-400 text-sm">
            <div class="flex gap-4">
               <span>üí¨ ${post.commentCount} comentarios</span>
               <div class="flex gap-2">
                 ${Object.entries(post.groupedReactions).map(([type, count]) => `
                   <span class="bg-gray-800 px-2 rounded text-xs border border-gray-700">${type === 'LIKE'?'üëç':type==='LOVE'?'‚ù§Ô∏è':type==='FUNNY'?'üòÇ':'üòÆ'} ${count}</span>
                 `).join('')}
               </div>
            </div>
          </div>

          ${renderReactionButtons(post)}
        </div>
      </article>
    `).join('');
  };

  // --- FUNCI√ìN DETALLE: Ver Post Completo ---
  const renderPostDetail = (postId) => {
    const post = allPostsData.find(p => p.id === postId);
    if (!post) return;
    
    const commentsHtml = post.comments.length > 0
      ? post.comments.map(c => `
          <div class="bg-gray-800 border border-gray-700 p-4 rounded-lg">
             <div class="flex justify-between mb-1">
                <span class="font-bold text-[#00ffbb]">${c.author.username}</span>
                <span class="text-xs text-gray-500">${new Date(c.createdAt).toLocaleDateString()}</span>
             </div>
             <p class="text-gray-300">${c.content}</p>
          </div>
        `).join('')
      : '<p class="text-gray-500 italic">S√© el primero en comentar.</p>';

    contentContainer.innerHTML = `
      <div>
        <button onclick="renderInitialView()" class="mb-4 text-[#00ffbb] hover:underline">&larr; Volver al listado</button>
        
        <article class="bg-gray-900 rounded-lg p-6 border border-[#64ffd6] shadow-xl shadow-[#00ffbb]/20">
          <h1 class="text-3xl font-bold text-[#00ffbb] mb-2">${post.title}</h1>
          <p class="text-gray-400 text-sm mb-6">Publicado por ${post.author.username}</p>
          
          <div class="text-gray-200 text-lg whitespace-pre-line mb-6">${post.content}</div>
          
          ${renderMediaGrid(post.media)}
          
          <div class="mt-6 pt-4 border-t border-gray-800">
            <h4 class="text-[#00ffbb] mb-2 font-bold">Reaccionar:</h4>
            ${renderReactionButtons(post)}
          </div>
        </article>
        
        <div class="mt-8">
          <h3 class="text-2xl text-white font-bold mb-4">Comentarios (${post.comments.length})</h3>
          
          <form action="/api/posts/comment" method="POST" class="mb-8 flex flex-col gap-2 bg-gray-800 p-4 rounded-lg border border-gray-700">
            <input type="hidden" name="postId" value="${post.id}" />
            <input type="hidden" name="authorId" value="${currentUserId}" />
            <textarea 
              name="content" 
              rows="2" 
              placeholder="Escribe un comentario..." 
              required
              class="w-full bg-[#111] text-white p-3 rounded border border-gray-600 focus:border-[#00ffbb] outline-none resize-none"
            ></textarea>
            <div class="flex justify-end">
              <button type="submit" class="bg-[#00ffbb] text-black font-bold px-4 py-2 rounded hover:bg-white transition">Comentar</button>
            </div>
          </form>

          <div class="space-y-4">${commentsHtml}</div>
        </div>
      </div>`;
  };

  // --- L√ìGICA DE REACCIONES (FETCH) ---
  window.handleReaction = async (postId, type) => {
    try {
      const res = await fetch('/api/posts/reactions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId, userId: currentUserId, type })
      });
      
      if (res.ok) {
        // Recargar la p√°gina para ver los cambios actualizados
        // (Podr√≠amos actualizar el DOM manualmente, pero reload es m√°s seguro para sincronizar contadores)
        window.location.reload(); 
      }
    } catch (err) {
      console.error("Error reaccionando", err);
    }
  };

  const renderCommentsList = (comments) => { /* ... c√≥digo anterior simplificado ... */
     return comments.map(c => `<div class="bg-gray-800 p-4 mb-2 rounded border border-gray-700"><span class="text-[#00ffbb] font-bold">${c.author.username}</span> coment√≥ en "${c.post.title}": <br><span class="text-gray-300">${c.content}</span></div>`).join('');
  };

  // Setup inicial
  const renderInitialView = () => { contentContainer.innerHTML = renderPosts(allPostsData); };
  window.renderInitialView = renderInitialView;

  // Listeners Botones Filtros
  showAllBtn.addEventListener('click', renderInitialView);
  showPostsBtn.addEventListener('click', () => contentContainer.innerHTML = renderPosts(userPostsData));
  showCommentsBtn.addEventListener('click', () => contentContainer.innerHTML = renderCommentsList(userCommentsData));

  // Listeners Modal
  const modal = document.getElementById('create-post-modal');
  const openBtn = document.getElementById('open-modal-btn');
  const closeBtn = document.getElementById('close-modal-btn');
  
  if (openBtn && modal) {
    openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
  }
  
  // Delegaci√≥n de eventos para abrir detalle del post
  contentContainer.addEventListener('click', (event) => {
    // Si el clic fue en un bot√≥n de reacci√≥n, NO abrimos el post (stopPropagation ya est√° en el HTML, pero por seguridad)
    if (event.target.closest('button')) return;

    const postArticle = event.target.closest('article[data-post-id]');
    if (postArticle) {
      renderPostDetail(parseInt(postArticle.dataset.postId, 10));
    }
  });

  // Render inicial
  renderInitialView();
</script>