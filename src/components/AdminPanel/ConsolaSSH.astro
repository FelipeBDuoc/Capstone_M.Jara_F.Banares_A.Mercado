<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/progressbar.js@1.1.0/dist/progressbar.min.js"></script>

<div class="flex h-[calc(100vh-160px)] w-full text-gray-200 p-6 gap-6 box-border font-sans">
    
    <div class="w-1/5 flex flex-col rounded-lg border border-[#64ffd6] shadow-lg shadow-[#00ffbb]/25 overflow-hidden bg-[#1e2124]">
        <div class="px-6 py-3 bg-dark-secondary border-b border-[#64ffd6] text-left text-xs font-medium text-light uppercase tracking-wider">
            M√°quinas Virtuales
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="vm-list-left">
            </div>
    </div>
    
    <div class="w-3/5 flex flex-col rounded-lg border border-[#64ffd6] shadow-lg shadow-[#00ffbb]/25 overflow-hidden bg-[#1e2124]">
        <div class="px-6 py-3 bg-dark-secondary border-b border-[#64ffd6] text-left text-xs font-medium text-light uppercase tracking-wider">
            Consola SSH
        </div>
        
        <div class="flex-1 flex flex-col p-6 min-h-0 relative" id="console-container">
            <div class="no-selection flex justify-center items-center h-full text-gray-400 italic" id="no-vm-selected">
                Selecciona una m√°quina virtual para comenzar
            </div>
        </div>
    </div>
    
    <div class="w-1/5 flex flex-col rounded-lg border border-[#64ffd6] shadow-lg shadow-[#00ffbb]/25 overflow-hidden bg-[#1e2124]">
        <div class="px-6 py-3 bg-dark-secondary border-b border-[#64ffd6] text-left text-xs font-medium text-light uppercase tracking-wider">
            Recursos del Sistema
        </div>
        <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4" id="resources-container">
            <div class="no-selection flex justify-center items-center text-gray-400 italic h-full">
                Selecciona una VM
            </div>
        </div>
    </div>
</div>

<script>
// ========== 1. CONFIGURACI√ìN Y ESTADO GLOBAL ==========

const vmConfig = [
  { id: 100, name: "Ubuntu", host: "amercado.ddns.net" },
  { id: 101, name: "Windows", host: "amercado.ddns.net" },
  { id: 102, name: "Servidor Web", host: "host.para.vm.102" },
];

const vmListLeft = document.getElementById('vm-list-left');
const consoleContainer = document.getElementById('console-container');
const resourcesContainer = document.getElementById('resources-container');
const noVmSelected = document.getElementById('no-vm-selected');

let vmStore = new Map();
let selectedVMID = null;
let terminal = null;
let fitAddon = null;
let socket = null;
let isTerminalReady = false;
let cpuProgress = null;
let ramProgress = null;


// ========== 2. L√ìGICA DE DATOS (API PROXMOX) ==========

function translateStatus(status) {
    if (status === 'running') return 'Conectado';
    if (status === 'stopped') return 'Apagada';
    if (status === 'error') return 'Error API';
    if (status === 'loading') return 'Cargando...';
    return status; 
}

function formatUptime(seconds) {
    if (!seconds || seconds <= 0) return 'Apagada';
    if (seconds < 60) return 'Hace un momento';

    const d = Math.floor(seconds / (3600 * 24));
    const h = Math.floor((seconds % (3600 * 24)) / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    let parts = [];
    if (d > 0) parts.push(`${d}d`);
    if (h > 0) parts.push(`${h}h`);
    if (m > 0) parts.push(`${m}m`);
    if (parts.length === 0) return 'Hace un momento'; 
    return parts.join(' ');
}

function formatBytesToGB(bytes) {
    if (!bytes || bytes === 0) return '0.0';
    const gb = bytes / (1024 * 1024 * 1024);
    return gb.toFixed(1);
}

async function fetchAndRefreshData() {
    try {
        const response = await fetch('/api/monitor.json');
        if (!response.ok) {
            console.error('Error al cargar datos de la API');
            vmStore.forEach(vm => {
                if (vm.status === 'loading') vm.status = 'error';
            });
            renderVMList(); 
            return;
        }
        
        const apiDataArray = await response.json();
        apiDataArray.forEach(data => {
            const config = vmConfig.find(c => c.id === data.vmid);
            if (config) {
                const mergedVM = { ...data, host: config.host };
                vmStore.set(data.vmid, mergedVM);
            }
        });
        renderVMList();
        updateResourcesUI(); 

    } catch (error) {
        console.error('Error en fetchAndRefreshData:', error);
    }
}

function populateInitialStore() {
    vmStore.clear();
    vmConfig.forEach(vm => {
        vmStore.set(vm.id, {
            vmid: vm.id,
            name: vm.name,
            host: vm.host,
            status: 'loading',
            cpu: 0, mem: 0, maxmem: 1,
            disk: 0, maxdisk: 1,
            uptime: 0
        });
    });
}


// ========== 3. FUNCIONES DE UI (PANELES LATERALES) ==========

function destroyProgressBars() {
    if (cpuProgress) {
        cpuProgress.destroy();
        cpuProgress = null;
    }
    if (ramProgress) {
        ramProgress.destroy();
        ramProgress = null;
    }
}

/**
 * Renderiza la lista de VMs
 * MODIFICADO: Estilo de lista m√°s limpio y acorde al AdminPanel
 */
function renderVMList() {
    if (!vmListLeft) return;
    vmListLeft.innerHTML = ''; 

    if (vmStore.size === 0) {
        vmListLeft.innerHTML = '<div class="p-4 text-gray-400 italic text-sm">No hay VMs configuradas...</div>';
        return;
    }

    vmStore.forEach(vm => {
        const vmItem = document.createElement('div');
        // Estilo base: borde sutil, fondo oscuro
        vmItem.className = 'vm-item group flex flex-col p-3 rounded-md border border-dark-highlight cursor-pointer transition-all duration-200 hover:bg-dark-highlight/30 hover:border-[#64ffd6]/50';
        vmItem.dataset.id = vm.vmid;

        const statusText = translateStatus(vm.status);
        let statusDotColor = 'bg-gray-500';
        let statusTextColor = 'text-gray-400';

        if (vm.status === 'running') {
            statusDotColor = 'bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.6)]';
            statusTextColor = 'text-green-300';
        } else if (vm.status === 'stopped') {
            statusDotColor = 'bg-red-400';
            statusTextColor = 'text-red-300';
        } else if (vm.status === 'error') {
            statusDotColor = 'bg-red-600';
            statusTextColor = 'text-red-500 italic';
        } else if (vm.status === 'loading') {
            statusDotColor = 'bg-yellow-400';
            statusTextColor = 'text-yellow-300 italic';
        }
        
        vmItem.innerHTML = `
            <div class="flex items-center justify-between mb-1">
                <span class="font-semibold text-gray-200 group-hover:text-white">${vm.name}</span>
                <span class="w-2.5 h-2.5 rounded-full ${statusDotColor}"></span>
            </div>
            <div class="text-xs text-gray-500 flex justify-between">
                <span>${vm.host}</span>
                <span class="${statusTextColor}">${statusText}</span>
            </div>
        `;
        vmItem.addEventListener('click', () => selectVM(vm.vmid));
        vmListLeft.appendChild(vmItem);
    });

    if (selectedVMID) {
        const selectedItem = document.querySelector(`.vm-item[data-id="${selectedVMID}"]`);
        if (selectedItem) {
            // Estilo seleccionado: Borde Neon y fondo ligeramente iluminado
            selectedItem.classList.remove('border-dark-highlight');
            selectedItem.classList.add('bg-dark-highlight/50', 'border-[#64ffd6]', 'shadow-[0_0_10px_rgba(100,255,214,0.15)]');
        }
    }
}

/**
 * Renderiza el panel derecho (recursos)
 * MODIFICADO: Tarjetas con bordes sutiles para encajar dentro del contenedor principal
 */
function updateResourcesUI() {
    if (!resourcesContainer) return;

    if (!selectedVMID) {
        destroyProgressBars();
        resourcesContainer.innerHTML = `<div class="flex justify-center items-center h-full text-gray-500 italic text-sm">Selecciona una VM para ver m√©tricas</div>`;
        return;
    }
    const vm = vmStore.get(selectedVMID);
    if (!vm) {
        destroyProgressBars();
        resourcesContainer.innerHTML = `<div class="p-4 text-yellow-400 italic text-sm">Datos no encontrados...</div>`;
        return;
    }
    if (vm.status === 'loading') {
        destroyProgressBars();
        resourcesContainer.innerHTML = `<div class="p-4 text-yellow-400 italic text-sm">Cargando m√©tricas...</div>`;
        return;
    }
    if (vm.status === 'error') {
        destroyProgressBars();
        resourcesContainer.innerHTML = `<div class="p-4 text-red-400 italic text-sm">Error API</div>`;
        return;
    }

    // C√°lculos
    const cpuPercent = (vm.cpu || 0);
    const ramPercent = ((vm.mem || 0) / (vm.maxmem || 1));
    const storagePercentForBar = ((vm.disk || 0) / (vm.maxdisk || 1) * 100).toFixed(1);
    const storageUsedGB = formatBytesToGB(vm.disk || 0);
    const storageTotalGB = formatBytesToGB(vm.maxdisk || 1);
    const storageText = `${storageUsedGB} / ${storageTotalGB} GB`;
    const uptime = vm.uptime || 0;
    const statusText = translateStatus(vm.status);
    const statusClass = vm.status === 'running' ? 'text-green-400' : 'text-red-400';
    
    // HTML Estructura
    if (!cpuProgress) { 
        resourcesContainer.innerHTML = `
            <div class="bg-[#111] rounded-md p-4 border border-gray-700/50">
                <div class="flex justify-between gap-2">
                    <div class="flex flex-col items-center w-1/2">
                        <div class="text-[10px] uppercase tracking-wider text-gray-400 mb-2">CPU</div>
                        <div id="cpu-progress" class="relative w-16 h-16"></div> 
                    </div>
                    <div class="flex flex-col items-center w-1/2">
                        <div class="text-[10px] uppercase tracking-wider text-gray-400 mb-2">RAM</div>
                        <div id="ram-progress" class="relative w-16 h-16"></div>
                    </div>
                </div>
            </div>
            
            <div class="bg-[#111] rounded-md p-4 border border-gray-700/50">
                <div class="flex justify-between items-end mb-2">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400">Disco</div>
                    <div id="storage-percent-text" class="text-xs text-gray-200 font-mono">${storageText}</div>
                </div>
                <div class="w-full h-1.5 bg-gray-700 rounded-full overflow-hidden">
                    <div id="storage-bar" class="h-full bg-[#64ffd6] shadow-[0_0_10px_#64ffd6]" style="width: ${storagePercentForBar}%"></div>
                </div>
            </div>

            <div class="bg-[#111] rounded-md p-4 border border-gray-700/50 space-y-3">
                <div class="flex justify-between items-center">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400">Uptime</div>
                    <div id="uptime-text" class="text-xs text-gray-200 font-mono">${formatUptime(uptime)}</div>
                </div>
                <div class="h-px bg-gray-800 w-full"></div>
                <div class="flex justify-between items-center">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400">Estado</div>
                    <div id="status-text" class="text-xs font-bold ${statusClass}">${statusText}</div>
                </div>
            </div>
        `;
        
        // Inicializaci√≥n ProgressBar
        const commonProgressOptions = {
            strokeWidth: 10, trailWidth: 4, trailColor: '#1f2937', duration: 300, easing: 'linear',
            text: { className: 'progressbar-text text-xs font-mono text-gray-200', style: { position: 'absolute', left: '50%', top: '50%', padding: 0, margin: 0, transform: { prefix: true, value: 'translate(-50%, -50%)' } } },
            step: (state, circle) => { circle.setText(Math.round(circle.value() * 100) + '%'); }
        };

        cpuProgress = new ProgressBar.Circle('#cpu-progress', { ...commonProgressOptions, color: '#3b82f6' });
        ramProgress = new ProgressBar.Circle('#ram-progress', { ...commonProgressOptions, color: '#ec4899' });
    }

    // Actualizaci√≥n de Valores
    if (cpuProgress) cpuProgress.animate(cpuPercent); 
    if (ramProgress) ramProgress.animate(ramPercent);

    const storageBar = document.getElementById('storage-bar');
    const storageTextEl = document.getElementById('storage-percent-text');
    const uptimeText = document.getElementById('uptime-text');
    const statusTextEl = document.getElementById('status-text');

    if (storageBar) storageBar.style.width = `${storagePercentForBar}%`;
    if (storageTextEl) storageTextEl.textContent = storageText;
    if (uptimeText) uptimeText.textContent = formatUptime(uptime);
    if (statusTextEl) {
        statusTextEl.textContent = statusText;
        statusTextEl.className = `text-xs font-bold ${statusClass}`;
    }
}

function selectVM(vmid) {
    const vm = vmStore.get(vmid);
    if (!vm) return;

    destroyProgressBars(); 
    disconnectSSH();
    selectedVMID = vmid; 
    
    // Renderiza la lista para actualizar selecci√≥n
    renderVMList();
    updateConsole(vm); 
    updateResourcesUI();
}


// ========== 4. FUNCIONES SSH Y DE TERMINAL ==========

function updateConnectionStatus(status, color) {
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
        statusElement.textContent = status;
        // Mapeo simple de colores para Tailwind
        const colorClass = color === 'green' ? 'text-green-400' : (color === 'yellow' ? 'text-yellow-400' : 'text-red-400');
        statusElement.className = `${colorClass} font-mono`;
    }
}

function safeTerminalWrite(message) {
    if (terminal && isTerminalReady) {
        terminal.write(message);
        return true;
    }
    return false;
}

function initializeTerminal() {
    return new Promise((resolve, reject) => {
        try {
            if (terminal) {
                terminal.dispose();
                terminal = null;
                isTerminalReady = false;
            }
            const terminalElement = document.getElementById('terminal');
            if (!terminalElement) {
                reject(new Error('No terminal element'));
                return;
            }
            
            terminal = new Terminal({
                cursorBlink: true,
                theme: { background: '#000000', foreground: '#00ff00', cursor: '#00ff00' },
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace'
            });
            fitAddon = new FitAddon.FitAddon();
            terminal.loadAddon(fitAddon);
            terminal.open(terminalElement);
            
            setTimeout(() => {
                fitAddon.fit();
                isTerminalReady = true;
                resolve(terminal);
            }, 100);

            window.addEventListener('resize', () => {
                if (fitAddon && isTerminalReady) fitAddon.fit();
            });
        } catch (error) {
            isTerminalReady = false;
            reject(error);
        }
    });
}

/**
 * Actualiza el panel central (Consola)
 * MODIFICADO: Estilos de botones para coincidir con UserAdmin
 */
function updateConsole(vm) {
    if (!consoleContainer || !noVmSelected) return;
    noVmSelected.style.display = 'none';
    
    consoleContainer.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col">
                <span class="text-lg font-semibold text-white tracking-wide">${vm.name}</span>
                <span class="text-xs text-gray-500 font-mono">${vm.host}</span>
            </div>
            
            <div class="flex gap-3">
                <button class="connect-btn px-4 py-2 text-sm font-semibold text-white bg-green-600/80 hover:bg-green-600 border border-green-500 rounded-md transition-all shadow-[0_0_10px_rgba(74,222,128,0.2)] disabled:opacity-50">
                    Conectar
                </button>
                <button class="disconnect-btn px-4 py-2 text-sm font-semibold text-white bg-red-600/80 hover:bg-red-600 border border-red-500 rounded-md transition-all shadow-[0_0_10px_rgba(248,113,113,0.2)] disabled:opacity-50">
                    Desconectar
                </button>
            </div>
        </div>
        
        <div class="flex-1 bg-black rounded border border-gray-700 overflow-hidden p-1 relative shadow-inner">
            <div id="terminal" class="h-full w-full"></div>
        </div>
        
        <div class="flex justify-end mt-2">
            <span class="text-xs text-gray-500">Estado: <span id="connection-status" class="text-gray-400">Listo para conectar</span></span>
        </div>
    `;
    
    setTimeout(async () => {
        await initializeTerminal();
    }, 50);

    setTimeout(() => {
        const connectBtn = document.querySelector('.connect-btn');
        const disconnectBtn = document.querySelector('.disconnect-btn');
        if (connectBtn) connectBtn.onclick = () => connectSSH(vm);
        if (disconnectBtn) disconnectBtn.onclick = disconnectSSH;
    }, 100);
}

async function connectSSH(vm) {
    if (!vm) return;
    if (!isTerminalReady) await initializeTerminal();

    safeTerminalWrite(`\r\n\x1b[1;33müîÑ Iniciando conexi√≥n a ${vm.name}...\x1b[0m\r\n`);
    
    // (Simulaci√≥n de health check para simplificar el c√≥digo visual, l√≥gica real abajo)
    try {
        const response = await fetch('http://localhost:3001/health');
        if (!response.ok) throw new Error('Backend offline');
    } catch (error) {
        safeTerminalWrite(`\x1b[1;31m‚ùå Error Backend: ${error.message}\x1b[0m\r\n`);
        return;
    }
    
    const backendUrl = 'ws://localhost:3001/ssh';
    socket = new WebSocket(backendUrl);
    
    socket.onopen = () => {
        safeTerminalWrite('\x1b[1;32m‚úÖ Socket Abierto. Autenticando...\x1b[0m\r\n');
        updateConnectionStatus('Conectando...', 'yellow');
        socket.send(JSON.stringify({ type: 'connect', vmId: vm.vmid }));
    };
    
    socket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.type === 'output') {
                safeTerminalWrite(data.data);
            } else if (data.type === 'status') {
                safeTerminalWrite(`\r\n\x1b[1;36m${data.message}\x1b[0m\r\n`);
                updateConnectionStatus('Conectado', 'green');
            } else if (data.type === 'error') {
                safeTerminalWrite(`\r\n\x1b[1;31m‚ùå ${data.message}\x1b[0m\r\n`);
                updateConnectionStatus('Error', 'red');
            }
        } catch (e) {}
    };
    
    socket.onclose = (event) => {
        safeTerminalWrite('\r\n\x1b[1;33müîå Conexi√≥n cerrada\x1b[0m\r\n');
        updateConnectionStatus('Desconectado', 'red');
    };
    
    socket.onerror = () => {
        safeTerminalWrite('\r\n\x1b[1;31m‚ùå Error de conexi√≥n WebSocket\x1b[0m\r\n');
        updateConnectionStatus('Error', 'red');
    };
    
    if (terminal && isTerminalReady) {
        terminal.onData((data) => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'input', data: data }));
            }
        });
    }
}

function disconnectSSH() {
    if (socket) {
        socket.close();
        socket = null;
    }
    safeTerminalWrite('\r\n\x1b[1;33müîå Desconectado por el usuario\x1b[0m\r\n');
    updateConnectionStatus('Desconectado', 'red');
}

// ========== 5. INICIALIZACI√ìN ==========

document.addEventListener('DOMContentLoaded', () => {
    populateInitialStore();
    renderVMList();
    fetchAndRefreshData();
    setInterval(fetchAndRefreshData, 5000);
});
</script>