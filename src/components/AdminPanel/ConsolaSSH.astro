<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/progressbar.js@1.1.0/dist/progressbar.min.js"></script>

<div class="flex h-[calc(100vh-160px)] w-full text-gray-200 p-6 gap-6 box-border font-sans">
    
    <div class="w-1/5 flex flex-col rounded-lg border border-[#64ffd6] shadow-lg shadow-[#00ffbb]/25 overflow-hidden bg-[#1e2124]">
        <div class="px-6 py-3 bg-dark-secondary border-b border-[#64ffd6] text-left text-xs font-medium text-light uppercase tracking-wider flex justify-between items-center">
            <span>Inventario</span>
            <span class="text-[10px] text-gray-500">ID Asc</span>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="vm-list-left">
            <div class="flex justify-center items-center h-full">
                <span class="text-yellow-400 italic text-sm animate-pulse">Cargando...</span>
            </div>
        </div>
    </div>
    
    <div class="w-3/5 flex flex-col rounded-lg border border-[#64ffd6] shadow-lg shadow-[#00ffbb]/25 overflow-hidden bg-[#1e2124]">
        <div class="px-6 py-3 bg-dark-secondary border-b border-[#64ffd6] text-left text-xs font-medium text-light uppercase tracking-wider">
            Consola SSH
        </div>
        
        <div class="flex-1 flex flex-col p-6 min-h-0 relative" id="console-container">
            <div class="no-selection flex justify-center items-center h-full text-gray-400 italic" id="no-vm-selected">
                Selecciona una m√°quina virtual para comenzar
            </div>
        </div>
    </div>
    
    <div class="w-1/5 flex flex-col rounded-lg border border-[#64ffd6] shadow-lg shadow-[#00ffbb]/25 overflow-hidden bg-[#1e2124]">
        <div class="px-6 py-3 bg-dark-secondary border-b border-[#64ffd6] text-left text-xs font-medium text-light uppercase tracking-wider">
            Monitor
        </div>
        <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-4" id="resources-container">
            <div class="no-selection flex justify-center items-center text-gray-400 italic h-full">
                Selecciona una VM
            </div>
        </div>
    </div>
</div>

<script>
// ========== 1. ESTADO GLOBAL ==========
let vmStore = new Map();
let selectedVMID = null;
let terminal = null;
let fitAddon = null;
let socket = null;
let isTerminalReady = false;
let cpuProgress = null;
let ramProgress = null;

// Elementos DOM
const vmListLeft = document.getElementById('vm-list-left');
const consoleContainer = document.getElementById('console-container');
const resourcesContainer = document.getElementById('resources-container');
const noVmSelected = document.getElementById('no-vm-selected');

// ========== 2. LOGICA DE DATOS ==========

async function initializeSystem() {
    try {
        // 1. Sincronizar con Proxmox
        await fetch('/api/sync-vms', { method: 'POST' });
        // 2. Iniciar loop de datos
        fetchAndRefreshData();
        setInterval(fetchAndRefreshData, 5000);
    } catch (e) {
        console.error("Error init:", e);
    }
}

function translateStatus(status) {
    if (status === 'running') return 'Online';
    if (status === 'stopped') return 'Offline';
    if (status === 'error') return 'Error';
    return status; 
}

function formatUptime(seconds) {
    if (!seconds || seconds <= 0) return '-';
    const d = Math.floor(seconds / (3600 * 24));
    const h = Math.floor((seconds % (3600 * 24)) / 3600);
    if (d > 0) return `${d}d ${h}h`;
    const m = Math.floor((seconds % 3600) / 60);
    return `${h}h ${m}m`;
}

function formatBytesToGB(bytes) {
    if (!bytes) return '0.0';
    return (bytes / (1024 * 1024 * 1024)).toFixed(1);
}

// Iconos SVG para distinguir tipos
function getTypeIcon(type) {
    // CT (Contenedor) -> Icono de Caja/Cubo
    if (type === 'CT' || type === 'LXC') {
        return `<svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>`;
    }
    // VM (Virtual Machine) -> Icono de Servidor/Chip
    return `<svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path></svg>`;
}

async function fetchAndRefreshData() {
    try {
        const response = await fetch('/api/monitor.json');
        if (!response.ok) return;
        
        const apiDataArray = await response.json();
        
        apiDataArray.forEach(data => {
            const host = data.host || 'unknown';
            const name = data.name || `VM ${data.vmid}`;
            // Guardamos todo en el mapa
            vmStore.set(data.vmid, { ...data, host, name });
        });

        renderVMList();
        updateResourcesUI(); 

    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

// ========== 3. RENDERIZADO ==========

function renderVMList() {
    if (!vmListLeft) return;
    vmListLeft.innerHTML = ''; 

    if (vmStore.size === 0) {
        vmListLeft.innerHTML = '<div class="p-4 text-gray-500 italic text-center text-xs">Sin conexi√≥n</div>';
        return;
    }

    // --- ORDENAMIENTO POR ID ---
    const sortedVMs = Array.from(vmStore.values()).sort((a, b) => a.vmid - b.vmid);

    sortedVMs.forEach(vm => {
        const isActive = vm.vmid === selectedVMID;
        const vmItem = document.createElement('div');
        
        // Estilos base
        let baseClass = "group flex flex-col p-3 rounded-md border cursor-pointer transition-all duration-200 mb-2 ";
        
        // Estilos activo vs inactivo
        if (isActive) {
            baseClass += "bg-dark-highlight/40 border-[#64ffd6] shadow-[0_0_10px_rgba(100,255,214,0.1)]";
        } else {
            baseClass += "border-dark-highlight bg-[#15171a] hover:bg-dark-highlight/20 hover:border-[#64ffd6]/40";
        }

        vmItem.className = baseClass;

        // Estado (Running/Stopped)
        const isRunning = vm.status === 'running';
        const statusColor = isRunning ? 'bg-green-400 shadow-[0_0_6px_rgba(74,222,128,0.8)]' : 'bg-red-500/50';
        const statusText = translateStatus(vm.status);
        const typeIcon = getTypeIcon(vm.type);

        vmItem.innerHTML = `
            <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2 overflow-hidden">
                    ${typeIcon}
                    <span class="font-bold text-sm text-gray-200 truncate" title="${vm.name}">${vm.name}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-mono text-gray-500">#${vm.vmid}</span>
                    <span class="w-2 h-2 rounded-full ${statusColor}"></span>
                </div>
            </div>
            <div class="flex justify-between items-center mt-1">
                <span class="text-[10px] text-gray-500 font-mono truncate max-w-[100px]">${vm.host}</span>
                <span class="text-[10px] ${isRunning ? 'text-green-300' : 'text-red-400'}">${statusText}</span>
            </div>
        `;
        
        vmItem.addEventListener('click', () => selectVM(vm.vmid));
        vmListLeft.appendChild(vmItem);
    });
}

function updateResourcesUI() {
    if (!resourcesContainer) return;
    
    if (!selectedVMID) {
        destroyProgressBars();
        resourcesContainer.innerHTML = `<div class="flex justify-center items-center h-full text-gray-500 italic text-xs">Selecciona una m√°quina</div>`;
        return;
    }
    
    const vm = vmStore.get(selectedVMID);
    if (!vm) return;

    // M√©tricas
    const cpuPercent = vm.cpu || 0;
    const ramPercent = (vm.mem && vm.maxmem) ? (vm.mem / vm.maxmem) : 0;
    const diskPercent = (vm.disk && vm.maxdisk) ? ((vm.disk / vm.maxdisk) * 100) : 0;
    
    // Si no existen las barras, creamos el HTML
    if (!cpuProgress) { 
        resourcesContainer.innerHTML = `
            <div class="bg-[#111] rounded p-3 border border-gray-700/50">
                <div class="flex justify-between gap-2 mb-2">
                    <div class="flex flex-col items-center w-1/2">
                        <div class="text-[10px] text-gray-400 mb-1">CPU</div>
                        <div id="cpu-progress" class="relative w-14 h-14"></div> 
                    </div>
                    <div class="flex flex-col items-center w-1/2">
                        <div class="text-[10px] text-gray-400 mb-1">RAM</div>
                        <div id="ram-progress" class="relative w-14 h-14"></div>
                    </div>
                </div>
            </div>
            
            <div class="bg-[#111] rounded p-3 border border-gray-700/50">
                <div class="flex justify-between items-end mb-1">
                    <div class="text-[10px] text-gray-400">Disco</div>
                    <div class="text-[10px] text-gray-300 font-mono">
                        ${formatBytesToGB(vm.disk)} / ${formatBytesToGB(vm.maxdisk)} GB
                    </div>
                </div>
                <div class="w-full h-1 bg-gray-700 rounded-full overflow-hidden">
                    <div id="storage-bar" class="h-full bg-[#64ffd6]" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-[#111] rounded p-3 border border-gray-700/50 space-y-2">
                <div class="flex justify-between">
                    <span class="text-[10px] text-gray-400">Uptime</span>
                    <span id="uptime-text" class="text-[10px] text-gray-200 font-mono">-</span>
                </div>
                 <div class="flex justify-between">
                    <span class="text-[10px] text-gray-400">Tipo</span>
                    <span class="text-[10px] text-purple-300 font-bold">${vm.type}</span>
                </div>
            </div>
        `;
        
        const opts = {
            strokeWidth: 8, trailWidth: 2, trailColor: '#1f2937', duration: 400,
            text: { className: 'text-[10px] font-mono text-gray-200', style: { position: 'absolute', left: '50%', top: '50%', padding: 0, margin: 0, transform: { prefix: true, value: 'translate(-50%, -50%)' } } },
            step: (state, circle) => { circle.setText(Math.round(circle.value() * 100) + '%'); }
        };
        cpuProgress = new ProgressBar.Circle('#cpu-progress', { ...opts, color: '#3b82f6' });
        ramProgress = new ProgressBar.Circle('#ram-progress', { ...opts, color: '#ec4899' });
    }

    // Actualizar valores visuales
    if(cpuProgress) cpuProgress.animate(cpuPercent);
    if(ramProgress) ramProgress.animate(ramPercent);

    const storageBar = document.getElementById('storage-bar');
    if (storageBar) storageBar.style.width = `${diskPercent}%`;
    
    const uptimeText = document.getElementById('uptime-text');
    if (uptimeText) uptimeText.textContent = formatUptime(vm.uptime);
}

function destroyProgressBars() {
    if (cpuProgress) { cpuProgress.destroy(); cpuProgress = null; }
    if (ramProgress) { ramProgress.destroy(); ramProgress = null; }
}

function selectVM(vmid) {
    if (selectedVMID === vmid) return;
    const vm = vmStore.get(vmid);
    if (!vm) return;

    destroyProgressBars(); 
    disconnectSSH();
    selectedVMID = vmid;
    
    renderVMList(); // Re-render para actualizar selecci√≥n visual
    updateConsole(vm); 
    updateResourcesUI();
}

// ========== 4. TERMINAL & SSH ==========

function safeTerminalWrite(msg) {
    if (terminal && isTerminalReady) terminal.write(msg);
}

function updateConnectionStatus(status, color) {
    const el = document.getElementById('connection-status');
    if (el) {
        el.textContent = status;
        el.className = color === 'green' ? 'text-green-400' : (color === 'yellow' ? 'text-yellow-400' : 'text-red-400');
    }
}

async function initializeTerminal() {
    return new Promise((resolve) => {
        if (terminal) { terminal.dispose(); terminal = null; isTerminalReady = false; }
        
        const el = document.getElementById('terminal');
        if (!el) return;

        terminal = new Terminal({
            cursorBlink: true,
            theme: { background: '#000000', foreground: '#00ff00' },
            fontSize: 13,
            fontFamily: 'Menlo, monospace'
        });
        fitAddon = new FitAddon.FitAddon();
        terminal.loadAddon(fitAddon);
        terminal.open(el);
        
        setTimeout(() => {
            fitAddon.fit();
            isTerminalReady = true;
            resolve(terminal);
        }, 100);
        
        window.addEventListener('resize', () => { if(fitAddon) fitAddon.fit(); });
    });
}

function updateConsole(vm) {
    if (!consoleContainer || !noVmSelected) return;
    noVmSelected.style.display = 'none';
    
    const typeLabel = vm.type === 'CT' || vm.type === 'LXC' ? 'Contenedor LXC' : 'M√°quina Virtual';

    consoleContainer.innerHTML = `
        <div class="flex justify-between items-center mb-4 bg-[#111] p-3 rounded border border-gray-800">
            <div class="flex flex-col">
                <div class="flex items-center gap-2">
                    <span class="text-lg font-semibold text-white tracking-wide">${vm.name}</span>
                    <span class="text-[10px] bg-gray-700 px-2 rounded text-gray-300 border border-gray-600">${typeLabel}</span>
                </div>
                <span class="text-xs text-gray-500 font-mono mt-1">${vm.host} (Puerto utilizado:${vm.sshPort})</span>
            </div>
            
            <div class="flex gap-2">
                <button class="connect-btn px-3 py-1 text-xs font-bold text-white bg-green-700 hover:bg-green-600 border border-green-600 rounded shadow-md transition-all">
                    CONECTAR
                </button>
                <button class="disconnect-btn px-3 py-1 text-xs font-bold text-white bg-red-700 hover:bg-red-600 border border-red-600 rounded shadow-md transition-all">
                    CERRAR
                </button>
            </div>
        </div>
        
        <div class="flex-1 bg-black rounded border border-gray-700 overflow-hidden p-1 relative shadow-inner h-full">
            <div id="terminal" class="h-full w-full"></div>
        </div>
        
        <div class="flex justify-end mt-2 h-4">
            <span class="text-[10px] text-gray-600">Estado SSH: <span id="connection-status" class="text-gray-500">Inactivo</span></span>
        </div>
    `;
    
    setTimeout(async () => { await initializeTerminal(); }, 50);
    setTimeout(() => {
        document.querySelector('.connect-btn').onclick = () => connectSSH(vm);
        document.querySelector('.disconnect-btn').onclick = disconnectSSH;
    }, 100);
}

async function connectSSH(vm) {
    if (!vm) return;
    if (!isTerminalReady) await initializeTerminal();

    safeTerminalWrite(`\r\n\x1b[1;33müîÑ Iniciando conexi√≥n segura a ${vm.name}...\x1b[0m\r\n`);
    
    // Check Health
    try {
        const h = await fetch('http://localhost:3001/health');
        if(!h.ok) throw new Error();
    } catch {
        safeTerminalWrite(`\x1b[1;31m‚ùå Error: El servicio SSH Proxy no responde (puerto 3001).\x1b[0m\r\n`);
        return;
    }

    const wsUrl = 'ws://localhost:3001/ssh';
    socket = new WebSocket(wsUrl);
    
    socket.onopen = () => {
        safeTerminalWrite('\x1b[1;34müîí Canal seguro establecido. Autenticando...\x1b[0m\r\n');
        updateConnectionStatus('Negociando...', 'yellow');
        socket.send(JSON.stringify({ type: 'connect', vmId: vm.vmid }));
    };
    
    socket.onmessage = (e) => {
        try {
            const d = JSON.parse(e.data);
            if (d.type === 'output') safeTerminalWrite(d.data);
            else if (d.type === 'status') {
                safeTerminalWrite(`\r\n\x1b[1;36m${d.message}\x1b[0m\r\n`);
                if(d.message.includes('exitosa')) updateConnectionStatus('Conectado', 'green');
            }
            else if (d.type === 'error') {
                safeTerminalWrite(`\r\n\x1b[1;31m‚ùå ${d.message}\x1b[0m\r\n`);
                updateConnectionStatus('Error', 'red');
            }
        } catch {}
    };
    
    socket.onclose = () => {
        safeTerminalWrite('\r\n\x1b[1;33müîå Conexi√≥n finalizada.\x1b[0m\r\n');
        updateConnectionStatus('Desconectado', 'red');
    };
    
    if (terminal) {
        terminal.onData((key) => {
            if (socket && socket.readyState === 1) socket.send(JSON.stringify({ type: 'input', data: key }));
        });
    }
}

function disconnectSSH() {
    if (socket) { socket.close(); socket = null; }
}

document.addEventListener('DOMContentLoaded', initializeSystem);
</script>